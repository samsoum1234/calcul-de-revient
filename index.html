<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CalculRevientTN - Application Collaborative</title>

<!-- CSS / libs -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary: #2c3e50;
  --accent: #3498db;
  --secondary: #6a11cb;
  --success: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
  --bg: #f5f7fa;
  --card-bg: #ffffff;
  --text: #333333;
  --text-light: #7f8c8d;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  --gradient: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
  --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  --gradient-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

* {
  transition: all 0.3s ease;
}

body {
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  padding: 12px;
  font-family: 'Segoe UI', Inter, Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
}

.loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.auth-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px 0;
}

.auth-card {
  max-width: 480px;
  width: 100%;
  margin: 20px auto;
  padding: 0;
  background: var(--card-bg);
  border-radius: 18px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.auth-header {
  background: var(--gradient);
  color: #fff;
  padding: 18px 24px 12px 24px;
  display: flex;
  align-items: center;
  gap: 1.5rem;
  border-bottom: 1px solid rgba(0,0,0,0.07);
}

.auth-header .company-logo {
  height: 56px;
  width: 56px;
  object-fit: contain;
  background: #fff;
  padding: 6px;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.auth-header .flag {
  height: 35px;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.10);
}

.auth-content {
  padding: 28px 28px 18px 28px;
}

.app-header {
  background: var(--gradient);
  color: #fff;
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 24px;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.company-logo {
  height: 56px;
  object-fit: contain;
  background: #fff;
  padding: 6px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.10);
}

.flag {
  height: 44px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.10);
}

.panel {
  background: var(--card-bg);
  padding: 22px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  border: none;
  transition: box-shadow 0.2s, transform 0.2s;
}

.panel:hover {
  box-shadow: 0 8px 32px rgba(52, 152, 219, 0.10);
  transform: translateY(-2px);
}

.btn {
  border-radius: 50px;
  padding: 10px 20px;
  font-weight: 600;
  transition: all 0.3s;
  border: none;
}

.btn-primary { 
  background: var(--gradient); 
}

.btn-primary:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.btn-success { 
  background: var(--gradient-success);
}

.btn-danger { 
  background: var(--gradient-danger);
}

.table { 
  border-radius: 8px; 
  overflow: hidden; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}

.form-control { 
  border-radius: 8px; 
  padding: 10px 15px; 
  border: 1px solid #ddd; 
  transition: all 0.3s;
}

.form-control:focus { 
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.18); 
  border-color: var(--accent);
}

.form-control.is-invalid {
  border-color: var(--danger);
}

.nav-tabs .nav-link { 
  border-radius: 8px 8px 0 0; 
  padding: 12px 20px; 
  font-weight: 600; 
  color: var(--text-light);
}

.nav-tabs .nav-link.active { 
  background: var(--card-bg); 
  border-bottom: none; 
  color: var(--primary);
}

.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

.calc-row {
  transition: all 0.3s;
}

.calc-row:hover {
  background-color: rgba(52, 152, 219, 0.05);
}

.calc-row:has(.form-control:focus) {
  background-color: rgba(52, 152, 219, 0.08);
}

.remove-row {
  opacity: 0.7;
  transition: all 0.3s;
}

.remove-row:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* Nouvelles classes pour les fonctionnalités collaboratives */
.online-indicator {
  width: 8px;
  height: 8px;
  background: #27ae60;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
  animation: pulse 2s infinite;
}

.offline-indicator {
  width: 8px;
  height: 8px;
  background: #e74c3c;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.sync-status {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card-bg);
  padding: 8px 16px;
  border-radius: 20px;
  box-shadow: var(--shadow);
  z-index: 1000;
  font-size: 0.85rem;
}

.team-member {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  background: rgba(52, 152, 219, 0.1);
  border-radius: 8px;
  margin-bottom: 5px;
}

.project-card {
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  cursor: pointer;
  transition: all 0.3s;
}

.project-card:hover {
  border-color: var(--accent);
  box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
}

.project-card.active {
  border-color: var(--accent);
  background: rgba(52, 152, 219, 0.05);
}

@media (max-width: 768px) {
  .auth-card { 
    margin: 16px auto; 
  }
  
  .app-header { 
    padding: 12px;
    flex-direction: column;
    text-align: center;
    gap: 15px;
  }
  
  .company-logo { 
    height: 40px;
  }
  
  .auth-header {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
    padding: 15px;
  }
  
  .app-header > div {
    width: 100%;
    justify-content: center !important;
  }
  
  .table-responsive {
    font-size: 0.85rem;
  }
  
  .btn {
    padding: 8px 16px;
    font-size: 0.9rem;
  }
}

/* Animation pour les nouvelles lignes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.new-row {
  animation: fadeIn 0.5s ease;
}

/* Styles pour les indicateurs de chargement */
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Styles pour les notifications toast */
.toast {
  background: var(--card-bg);
  border-left: 4px solid var(--accent);
  box-shadow: var(--shadow);
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--danger);
}

.toast.warning {
  border-left-color: var(--warning);
}

/* Styles pour les documents */
.preview-link { 
  cursor: pointer; 
  color: var(--accent); 
  text-decoration: none; 
  font-size: 0.85rem; 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  margin-top: 5px;
}

.modal-img-preview { 
  max-width: 100%; 
  border-radius: 8px; 
}

.remove-doc { 
  cursor: pointer; 
  color: var(--danger); 
  margin-left: 6px; 
}

.doc-attached-indicator { 
  color: green; 
  margin-right: 4px; 
  font-size: 0.9rem; 
  display: none; 
}

#docCounter { 
  font-weight: bold; 
  margin-bottom: 8px; 
}

#docCounter .badge { 
  font-size: 0.9rem; 
}

.doc-file {
  font-size: 0.8rem;
  padding: 5px;
}

.backup-indicator {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--card-bg);
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  font-size: 0.8rem;
  z-index: 1000;
}
</style>
</head>
<body>

<!-- Loading indicator -->
<div class="loading" id="loadingIndicator" style="display: none;">
  <div class="spinner"></div>
</div>

<!-- Sync status indicator -->
<div class="sync-status" id="syncStatus" style="display: none;">
  <span class="online-indicator"></span>
  <span id="syncText">Synchronisé</span>
</div>

<!-- Backup indicator -->
<div class="backup-indicator" id="backupIndicator" style="display: none;">
  <i class="fas fa-cloud-upload-alt me-1"></i>
  <span id="backupText">Sauvegarde automatique...</span>
</div>

<!-- Toast notifications container -->
<div class="toast-container" id="toastContainer"></div>

<!-- AUTH VIEW -->
<div id="authView">
  <div class="auth-container">
    <div class="auth-card" id="loginCard">
      <div class="auth-header">
        <img src="https://via.placeholder.com/56x56/3498db/ffffff?text=CR" alt="Logo" class="company-logo" id="loginLogo">
        <div>
          <div style="font-size:1.35rem;font-weight:700;" id="loginCompanyName">CalculRevient TN</div>
          <div style="font-size:0.95rem;opacity:.9;" id="loginCompanyAddress">Application Collaborative</div>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
      </div>
      <div class="auth-content">
        <h4 class="mb-4 text-center"><i class="fas fa-lock me-2"></i> Connexion</h4>
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="loginEmail" type="email" class="form-control" required>
            <div class="invalid-feedback">Veuillez saisir un email valide</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mot de passe</label>
            <input id="loginPassword" type="password" class="form-control" required>
            <div class="invalid-feedback">Le mot de passe est requis</div>
          </div>
          <div class="mb-3 small text-center">
            <a href="#" id="showRegisterLink">Créer un compte</a> &nbsp;|&nbsp;
            <a href="#" id="forgotPassLink">Mot de passe oublié</a>
          </div>
          <button class="btn btn-primary w-100 mt-2" type="submit" id="loginBtn">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
            Se connecter
          </button>
        </form>
      </div>
    </div>
    
    <div class="auth-card" id="registerCard" style="display:none;">
      <div class="auth-header">
        <img src="https://via.placeholder.com/56x56/3498db/ffffff?text=CR" alt="Logo" class="company-logo" id="registerLogo">
        <div>
          <div style="font-size:1.35rem;font-weight:700;" id="registerCompanyName">CalculRevient TN</div>
          <div style="font-size:0.95rem;opacity:.9;" id="registerCompanyAddress">Application Collaborative</div>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
      </div>
      <div class="auth-content">
        <h4 class="mb-4 text-center"><i class="fas fa-user-plus me-2"></i> Créer un compte</h4>
        <form id="registerForm">
          <div class="mb-3">
            <label>Nom complet</label>
            <input id="regName" class="form-control" required>
            <div class="invalid-feedback">Veuillez saisir votre nom</div>
          </div>
          <div class="mb-3">
            <label>Email</label>
            <input id="regEmail" type="email" class="form-control" required>
            <div class="invalid-feedback">Veuillez saisir un email valide</div>
          </div>
          <div class="mb-3">
            <label>Mot de passe</label>
            <input id="regPassword" type="password" class="form-control" required minlength="6">
            <div class="invalid-feedback">Le mot de passe doit contenir au moins 6 caractères</div>
          </div>
          <div class="mb-3">
            <label>Rôle dans l'équipe</label>
            <select id="regRole" class="form-control" required>
              <option value="">Sélectionner un rôle</option>
              <option value="manager">Manager</option>
              <option value="analyst">Analyste</option>
              <option value="contributor">Contributeur</option>
            </select>
            <div class="invalid-feedback">Veuillez sélectionner un rôle</div>
          </div>
          <div class="d-flex justify-content-between">
            <button id="cancelRegister" class="btn btn-outline-secondary">Annuler</button>
            <button class="btn btn-success" type="submit" id="registerBtn">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
              Créer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div id="mainApp" style="display:none;">
  <!-- Header -->
  <div class="app-header">
    <div class="d-flex align-items-center gap-3">
      <img id="companyLogo" src="https://via.placeholder.com/56x56/3498db/ffffff?text=CR" class="company-logo" alt="Logo">
      <div>
        <div id="companyName" style="font-weight:700;font-size:1.2rem;">CalculRevient TN</div>
        <div id="companyAddress" style="font-size:0.95rem;opacity:.9">Application Collaborative</div>
      </div>
    </div>
    <div class="text-end">
      <div style="font-size:0.95rem;opacity:.9">Conforme - TVA <span id="showTVA">19</span>%</div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
    </div>
  </div>

  <!-- PROJECT SELECTION PAGE -->
  <div id="projectPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-folder-open me-2"></i> Mes Projets</h3>
      <div>
        <button id="createProjectBtn" class="btn btn-success me-2"><i class="fas fa-plus"></i> Nouveau Projet</button>
        <button id="teamManagementBtn" class="btn btn-outline-primary me-2"><i class="fas fa-users"></i> Équipe</button>
        <button id="projectLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-8">
        <div class="panel">
          <h5 class="mb-3">Projets récents</h5>
          <div id="projectsList">
            <!-- Projects will be loaded here -->
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel">
          <h6 class="mb-3">Équipe en ligne</h6>
          <div id="teamMembersList">
            <!-- Team members will be loaded here -->
          </div>
        </div>
        <div class="panel">
          <h6 class="mb-3">Statistiques</h6>
          <div class="d-flex justify-content-between mb-2">
            <span>Projets actifs:</span>
            <span id="activeProjectsCount">0</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Calculs ce mois:</span>
            <span id="monthlyCalculationsCount">0</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Membres équipe:</span>
            <span id="teamMembersCount">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div id="adminPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-user-shield me-2"></i> Panneau Admin</h3>
      <div>
        <button id="gotoProjectsBtn" class="btn btn-outline-primary me-2">Mes Projets</button>
        <button id="adminLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="panel">
          <h5 class="mb-3">Paramètres de l'entreprise</h5>
          <div class="mb-3">
            <label>Nom société</label>
            <input id="settingsCompanyName" class="form-control">
          </div>
          <div class="mb-3">
            <label>Adresse</label>
            <input id="settingsAddress" class="form-control">
          </div>
          <div class="mb-3">
            <label>Logo (URL)</label>
            <input id="settingsLogoUrl" class="form-control" placeholder="https://...">
          </div>
          <div class="mb-3">
            <label>TVA (%)</label>
            <input id="settingsTVA" type="number" class="form-control" min="0" step="0.01">
          </div>
          <div class="mb-3">
            <label>Devise</label>
            <input id="settingsCurrency" class="form-control">
          </div>
          <div class="d-flex gap-2">
            <button id="saveSettings" class="btn btn-primary">Enregistrer</button>
            <button id="resetSettings" class="btn btn-outline-secondary">Réinitialiser</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="panel">
          <h5 class="mb-3">Gestion de l'équipe</h5>
          <div class="table-responsive">
            <table class="table table-sm" id="usersTable">
              <thead><tr><th>Nom</th><th>Email</th><th>Rôle</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="panel">
          <h5 class="mb-3">Sauvegarde & Export</h5>
          <button id="exportAllDataBtn" class="btn btn-outline-primary w-100 mb-2">
            <i class="fas fa-download"></i> Exporter toutes les données
          </button>
          <button id="importDataBtn" class="btn btn-outline-success w-100">
            <i class="fas fa-upload"></i> Importer des données
          </button>
          <input type="file" id="importFileInput" accept=".json" style="display: none;">
        </div>
      </div>
    </div>
  </div>

  <!-- APP PAGE -->
  <div id="appPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3><i class="fas fa-calculator me-2"></i> <span id="currentProjectName">Nouveau Calcul</span></h3>
        <small class="text-muted" id="projectInfo">Projet collaboratif</small>
      </div>
      <div>
        <span id="currentUserLabel" class="me-3 small text-muted"></span>
        <button id="shareProjectBtn" class="btn btn-outline-success me-2" title="Partager le projet">
          <i class="fas fa-share-alt"></i>
        </button>
        <button id="backToProjectsBtn" class="btn btn-outline-primary me-2">Projets</button>
        <button id="openAdmin" class="btn btn-outline-secondary me-2" title="Accès admin">
          <i class="fas fa-user-cog"></i>
        </button>
        <button id="appLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabCalc">Calcul</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabHistory">Historique</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabTeam">Équipe</a></li>
    </ul>

    <div class="tab-content mt-4">
      <!-- Calcul Tab -->
      <div id="tabCalc" class="tab-pane fade show active">
        <div class="row">
          <div class="col-md-8">
            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-table me-2"></i> Tableau de calcul</h5>
                <div>
                  <button id="addRow" class="btn btn-primary btn-sm me-2"><i class="fas fa-plus"></i> Ajouter</button>
                  <button id="btnCalculate" class="btn btn-success btn-sm"><i class="fas fa-calculator"></i> Calculer</button>
                  <button id="saveProjectBtn" class="btn btn-outline-primary btn-sm ms-2"><i class="fas fa-save"></i> Sauvegarder</button>
                </div>
              </div>
              <div id="docCounter" class="ms-2">Documents attachés : <span class="badge bg-secondary">0</span></div>
              <div class="table-responsive">
                <table class="table table-sm table-bordered calculation-table" id="calcTable">
                  <thead>
                    <tr>
                      <th>Description</th>
                      <th>Fournisseur</th>
                      <th>Unité</th>
                      <th>Prix HT</th>
                      <th>Prix TTC</th>
                      <th>Quantité</th>
                      <th>Total</th>
                      <th>Document</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="calc-row new-row">
                      <td><input class="form-control description" placeholder="Description"></td>
                      <td><input class="form-control supplier" placeholder="Fournisseur"></td>
                      <td>
                        <select class="form-control unit">
                          <option value="">Sélectionner</option>
                          <option>pièce</option><option>kg</option><option>m</option><option>m²</option><option>l</option>
                        </select>
                      </td>
                      <td><input type="number" class="form-control price-ht" step="0.01" min="0" placeholder="0.00"></td>
                      <td><input class="form-control price-ttc" readonly placeholder="0.00"></td>
                      <td><input type="number" class="form-control quantity" step="0.01" min="0" placeholder="0"></td>
                      <td><input class="form-control total" readonly placeholder="0.00"></td>
                      <td>
                        <input type="file" class="form-control form-control-sm doc-file" accept=".pdf,.jpg,.png,.jpeg">
                        <div class="preview-link d-none">
                          <span><i class="fas fa-check-circle doc-attached-indicator"></i><span class="file-name"></span></span>
                          <i class="fas fa-times remove-doc" title="Supprimer le document"></i>
                        </div>
                      </td>
                      <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="7" class="text-end fw-bold">Total général :</td>
                      <td id="globalTotalCell" class="fw-bold">0.00</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="panel">
              <h6 class="mb-3">Résumé</h6>
              <div class="d-flex justify-content-between mb-2"><span>Total HT:</span><span id="sumHT">0.00</span></div>
              <div class="d-flex justify-content-between mb-2"><span>TVA (<span id="showTVA2">19</span>%)</span><span id="sumTVA">0.00</span></div>
              <div class="d-flex justify-content-between mb-2"><span>Total TTC:</span><span id="sumTTC">0.00</span></div>
              <hr>
              <div class="d-flex justify-content-between fw-bold mb-3"><span>Total général:</span><span id="globalTotalSummary">0.00</span></div>
              <div class="mb-3">
                <label>Coefficient</label>
                <input id="coefficient" type="number" step="0.01" min="0" class="form-control" value="1">
              </div>
              <div class="d-flex justify-content-between fw-bold"><span>Prix final:</span><span id="finalPrice">0.00</span></div>
            </div>
            <div class="panel">
              <button id="exportPdfBtn" class="btn btn-outline-primary w-100 mb-2"><i class="fas fa-file-pdf"></i> Exporter (PDF)</button>
              <button id="exportExcelBtn" class="btn btn-outline-success w-100 mb-2"><i class="fas fa-file-excel"></i> Exporter (Excel)</button>
              <button id="sendMailBtn" class="btn btn-outline-danger w-100"><i class="fas fa-envelope"></i> Envoyer par mail</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- History Tab -->
      <div id="tabHistory" class="tab-pane fade">
        <div class="panel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-history me-2"></i> Historique du projet</h5>
            <div>
              <button id="clearProjectHistory" class="btn btn-outline-danger btn-sm">Effacer historique</button>
            </div>
          </div>
          <div class="table-responsive mb-4">
            <table class="table table-sm table-bordered" id="historyTable">
              <thead><tr><th>Date</th><th>Utilisateur</th><th>Total général</th><th>Coeff</th><th>Prix final</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="row">
            <div class="col-md-7">
              <canvas id="chartLine"></canvas>
            </div>
            <div class="col-md-5">
              <canvas id="chartPie"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Team Tab -->
      <div id="tabTeam" class="tab-pane fade">
        <div class="panel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-users me-2"></i> Équipe du projet</h5>
            <button id="inviteTeamMemberBtn" class="btn btn-success btn-sm">
              <i class="fas fa-user-plus"></i> Inviter
            </button>
          </div>
          <div id="projectTeamList">
            <!-- Team members will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="createProjectForm">
        <div class="modal-header">
          <h5 class="modal-title">Créer un nouveau projet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Nom du projet</label>
            <input id="projectName" class="form-control" required placeholder="Ex: Calcul Projet Alpha">
          </div>
          <div class="mb-3">
            <label>Description</label>
            <textarea id="projectDescription" class="form-control" rows="3" placeholder="Description du projet..."></textarea>
          </div>
          <div class="mb-3">
            <label>Type de projet</label>
            <select id="projectType" class="form-control" required>
              <option value="">Sélectionner</option>
              <option value="construction">Construction</option>
              <option value="renovation">Rénovation</option>
              <option value="manufacturing">Production</option>
              <option value="service">Service</option>
              <option value="other">Autre</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Créer le projet</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Share Project Modal -->
<div class="modal fade" id="shareProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Partager le projet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Lien de partage</label>
          <div class="input-group">
            <input id="shareLink" class="form-control" readonly>
            <button class="btn btn-outline-secondary" type="button" id="copyShareLink">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="mb-3">
          <label>Inviter par email</label>
          <div class="input-group">
            <input id="inviteEmail" type="email" class="form-control" placeholder="email@exemple.com">
            <button class="btn btn-primary" type="button" id="sendInviteBtn">
              <i class="fas fa-paper-plane"></i> Inviter
            </button>
          </div>
        </div>
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          Les personnes invitées pourront consulter et modifier ce projet en temps réel.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Forgot modal -->
<div class="modal fade" id="forgotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="forgotForm" class="p-3">
        <div class="modal-header"><h5 class="modal-title">Mot de passe oublié</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label>Email</label><input id="forgotEmail" type="email" class="form-control" required></div>
          <div class="mb-3"><label>Nouveau mot de passe</label><input id="forgotNewPass" type="password" class="form-control" required minlength="6"></div>
          <small class="text-muted">Si l'email existe, le mot de passe sera mis à jour.</small>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button type="submit" class="btn btn-primary">Réinitialiser</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Modal preview -->
<div class="modal fade" id="docPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Aperçu du document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="docPreviewImg" class="modal-img-preview d-none" />
        <p id="docPreviewInfo" class="text-muted"></p>
      </div>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// --------- Config / Storage keys ---------
const ADMIN_EMAIL = 'omri.sami@ymail.com';
const ADMIN_PASS = '21111989Ss**';
const KEY_USERS = 'cr_users_collaborative';
const KEY_SETTINGS = 'cr_settings_collaborative';
const KEY_PROJECTS = 'cr_projects_collaborative';
const KEY_CURRENT_PROJECT = 'cr_current_project';

const DEFAULT_SETTINGS = {
  companyName: 'CalculRevient TN',
  address: 'Tunisie',
  logoUrl: 'https://via.placeholder.com/56x56/3498db/ffffff?text=CR',
  tva: 19,
  currency: 'TND'
};

let settings = {...DEFAULT_SETTINGS};
let currentUser = null;
let currentProject = null;
let autoSaveInterval = null;

// --------- Helpers storage ---------
function loadSettings(){
  try{
    const raw = localStorage.getItem(KEY_SETTINGS);
    if(raw) settings = Object.assign({}, DEFAULT_SETTINGS, JSON.parse(raw));
    else settings = {...DEFAULT_SETTINGS};
  }catch(e){ settings = {...DEFAULT_SETTINGS}; }
  applySettingsToUI();
}

function saveSettings(){ 
  localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); 
  applySettingsToUI(); 
  showToast('Paramètres sauvegardés avec succès', 'success');
}

function getUsers(){ 
  try{ 
    return JSON.parse(localStorage.getItem(KEY_USERS) || '[]'); 
  }catch(e){ 
    return []; 
  } 
}

function saveUsers(u){ 
  localStorage.setItem(KEY_USERS, JSON.stringify(u)); 
}

function getProjects(){
  try{
    return JSON.parse(localStorage.getItem(KEY_PROJECTS) || '[]');
  }catch(e){
    return [];
  }
}

function saveProjects(projects){
  localStorage.setItem(KEY_PROJECTS, JSON.stringify(projects));
}

function getCurrentProject(){
  try{
    const projectId = localStorage.getItem(KEY_CURRENT_PROJECT);
    if(!projectId) return null;
    const projects = getProjects();
    return projects.find(p => p.id === projectId) || null;
  }catch(e){
    return null;
  }
}

function setCurrentProject(projectId){
  localStorage.setItem(KEY_CURRENT_PROJECT, projectId);
  currentProject = getCurrentProject();
}

// --------- UI shortcuts ---------
const loginCard = document.getElementById('loginCard');
const registerCard = document.getElementById('registerCard');
const authView = document.getElementById('authView');
const mainApp = document.getElementById('mainApp');
const projectPage = document.getElementById('projectPage');
const adminPage = document.getElementById('adminPage');
const appPage = document.getElementById('appPage');

// --------- Utility functions ---------
function escapeHtml(s){ 
  return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); 
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type} mb-2`;
  toast.innerHTML = `
    <div class="toast-body d-flex justify-content-between">
      <span>${message}</span>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
  `;
  document.getElementById('toastContainer').appendChild(toast);
  
  const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
  bsToast.show();
  
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

function showLoading(show) {
  document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function showSyncStatus(text, isOnline = true) {
  const syncStatus = document.getElementById('syncStatus');
  const syncText = document.getElementById('syncText');
  syncText.textContent = text;
  syncStatus.style.display = 'block';
  
  setTimeout(() => {
    syncStatus.style.display = 'none';
  }, 2000);
}

function showBackupIndicator(show = true) {
  document.getElementById('backupIndicator').style.display = show ? 'block' : 'none';
}

// --------- Auto-save functionality ---------
function startAutoSave() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  
  autoSaveInterval = setInterval(() => {
    if (currentProject) {
      saveCurrentProjectData();
      showBackupIndicator(true);
      setTimeout(() => showBackupIndicator(false), 1000);
    }
  }, 30000); // Auto-save every 30 seconds
}

function stopAutoSave() {
  if (autoSaveInterval) {
    clearInterval(autoSaveInterval);
    autoSaveInterval = null;
  }
}

// --------- Init on DOM ready ---------
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  bindAuth();
  bindAdmin();
  bindApp();
  bindProjects();
  refreshUsersTable();
  updateDocCounter();
});

// ---------------- AUTH ----------------
function bindAuth(){
  document.getElementById('showRegisterLink').addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    loginCard.style.display='none'; 
    registerCard.style.display='block'; 
  });
  
  document.getElementById('cancelRegister').addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    registerCard.style.display='none'; 
    loginCard.style.display='block'; 
  });
  
  document.getElementById('registerForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim().toLowerCase();
    const pass = document.getElementById('regPassword').value;
    const role = document.getElementById('regRole').value;
    
    // Validation
    let isValid = true;
    if(!name) {
      document.getElementById('regName').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regName').classList.remove('is-invalid');
    }
    
    if(!validateEmail(email)) {
      document.getElementById('regEmail').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regEmail').classList.remove('is-invalid');
    }
    
    if(!pass || pass.length < 6) {
      document.getElementById('regPassword').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regPassword').classList.remove('is-invalid');
    }
    
    if(!role) {
      document.getElementById('regRole').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regRole').classList.remove('is-invalid');
    }
    
    if(!isValid) {
      showToast('Veuillez corriger les erreurs dans le formulaire', 'error');
      return;
    }
    
    if(email === ADMIN_EMAIL){
      showToast('Email réservé (admin)', 'error');
      return;
    }
    
    const users = getUsers();
    if(users.some(u=>u.email===email)){
      showToast('Email déjà utilisé', 'error');
      return;
    }
    
    // Show loading
    const registerBtn = document.getElementById('registerBtn');
    const spinner = registerBtn.querySelector('.spinner-border');
    spinner.style.display = 'inline-block';
    registerBtn.disabled = true;
    
    // Simulate async operation
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    users.push({
      id: generateId(),
      name, 
      email, 
      password: pass, 
      role,
      joinedAt: new Date().toISOString(),
      lastActive: new Date().toISOString()
    });
    saveUsers(users);
    
    // Hide loading
    spinner.style.display = 'none';
    registerBtn.disabled = false;
    
    showToast('Compte créé — connectez-vous.', 'success');
    document.getElementById('registerForm').reset();
    registerCard.style.display='none'; 
    loginCard.style.display='block';
    refreshUsersTable();
  });
  
  document.getElementById('loginForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pass = document.getElementById('loginPassword').value;
    
    // Validation
    let isValid = true;
    if(!validateEmail(email)) {
      document.getElementById('loginEmail').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('loginEmail').classList.remove('is-invalid');
    }
    
    if(!pass) {
      document.getElementById('loginPassword').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('loginPassword').classList.remove('is-invalid');
    }
    
    if(!isValid) {
      showToast('Veuillez corriger les erreurs dans le formulaire', 'error');
      return;
    }
    
    // Show loading
    const loginBtn = document.getElementById('loginBtn');
    const spinner = loginBtn.querySelector('.spinner-border');
    spinner.style.display = 'inline-block';
    loginBtn.disabled = true;
    
    // Simulate async operation
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if(email === ADMIN_EMAIL && pass === ADMIN_PASS){
      currentUser = {id: 'admin', name: 'Admin', email: ADMIN_EMAIL, isAdmin: true, role: 'admin'};
      
      // Hide loading
      spinner.style.display = 'none';
      loginBtn.disabled = false;
      
      enterAdmin();
      return;
    }
    
    const users = getUsers();
    const u = users.find(x => x.email === email && x.password === pass);
    
    if(!u){ 
      // Hide loading
      spinner.style.display = 'none';
      loginBtn.disabled = false;
      
      showToast('Email ou mot de passe incorrect', 'error'); 
      return; 
    }
    
    // Update last active
    u.lastActive = new Date().toISOString();
    saveUsers(users);
    
    currentUser = {id: u.id, name: u.name, email: u.email, isAdmin: false, role: u.role};
    
    // Hide loading
    spinner.style.display = 'none';
    loginBtn.disabled = false;
      
    enterProjects();
  });
  
  const forgotModalEl = document.getElementById('forgotModal');
  const bsForgot = new bootstrap.Modal(forgotModalEl);
  
  document.getElementById('forgotPassLink').addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    document.getElementById('forgotForm').reset(); 
    bsForgot.show(); 
  });
  
  document.getElementById('forgotForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
    const newPass = document.getElementById('forgotNewPass').value;
    
    if(email === ADMIN_EMAIL){ 
      showToast("Impossible de réinitialiser le mot de passe admin ici.", 'error'); 
      return; 
    }
    
    if(!newPass || newPass.length < 6) {
      showToast("Le mot de passe doit contenir au moins 6 caractères", 'error');
      return;
    }
    
    const users = getUsers();
    const idx = users.findIndex(u=>u.email===email);
    if(idx === -1){ 
      showToast("Email non trouvé.", 'error'); 
      return; 
    }
    
    users[idx].password = newPass;
    saveUsers(users);
    showToast('Mot de passe mis à jour.', 'success');
    bsForgot.hide();
  });
}

// ---------------- ENTER PAGES ----------------
function applySettingsToUI(){
  document.getElementById('companyLogo').src = settings.logoUrl || DEFAULT_SETTINGS.logoUrl;
  document.getElementById('companyName').textContent = settings.companyName || '';
  document.getElementById('companyAddress').textContent = settings.address || '';
  document.getElementById('showTVA').textContent = settings.tva;
  document.getElementById('showTVA2').textContent = settings.tva;
  
  // Update auth cards
  document.getElementById('loginCompanyName').textContent = settings.companyName || '';
  document.getElementById('loginCompanyAddress').textContent = settings.address || '';
  document.getElementById('loginLogo').src = settings.logoUrl || DEFAULT_SETTINGS.logoUrl;
  document.getElementById('registerCompanyName').textContent = settings.companyName || '';
  document.getElementById('registerCompanyAddress').textContent = settings.address || '';
  document.getElementById('registerLogo').src = settings.logoUrl || DEFAULT_SETTINGS.logoUrl;
  
  if(document.getElementById('settingsCompanyName')) document.getElementById('settingsCompanyName').value = settings.companyName;
  if(document.getElementById('settingsAddress')) document.getElementById('settingsAddress').value = settings.address;
  if(document.getElementById('settingsLogoUrl')) document.getElementById('settingsLogoUrl').value = settings.logoUrl;
  if(document.getElementById('settingsTVA')) document.getElementById('settingsTVA').value = settings.tva;
  if(document.getElementById('settingsCurrency')) document.getElementById('settingsCurrency').value = settings.currency || DEFAULT_SETTINGS.currency;
  
  updateSummaryDisplay();
}

function enterAdmin(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='';
  projectPage.style.display='none';
  appPage.style.display='none';
  refreshUsersTable();
}

function enterProjects(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='none';
  projectPage.style.display='';
  appPage.style.display='none';
  document.getElementById('currentUserLabel').textContent = currentUser ? `${currentUser.name} (${currentUser.email})` : '';
  refreshProjectsList();
  refreshTeamStats();
}

function enterApp(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='none';
  projectPage.style.display='none';
  appPage.style.display='';
  document.getElementById('currentUserLabel').textContent = currentUser ? `${currentUser.name} (${currentUser.email})` : '';
  
  if(currentProject) {
    document.getElementById('currentProjectName').textContent = currentProject.name;
    document.getElementById('projectInfo').textContent = `Créé le ${new Date(currentProject.createdAt).toLocaleDateString()}`;
    loadProjectData();
  }
  
  refreshProjectHistory();
  refreshProjectTeam();
  startAutoSave();
}

// ---------------- PROJECTS MANAGEMENT ----------------
function bindProjects(){
  const createProjectModal = new bootstrap.Modal(document.getElementById('createProjectModal'));
  const shareProjectModal = new bootstrap.Modal(document.getElementById('shareProjectModal'));
  
  document.getElementById('createProjectBtn').addEventListener('click', () => {
    document.getElementById('createProjectForm').reset();
    createProjectModal.show();
  });
  
  document.getElementById('createProjectForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('projectName').value.trim();
    const description = document.getElementById('projectDescription').value.trim();
    const type = document.getElementById('projectType').value;
    
    if(!name || !type) {
      showToast('Veuillez remplir tous les champs requis', 'error');
      return;
    }
    
    const projects = getProjects();
    const newProject = {
      id: generateId(),
      name,
      description,
      type,
      createdBy: currentUser.id,
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString(),
      team: [currentUser.id],
      calculations: [],
      history: []
    };
    
    projects.push(newProject);
    saveProjects(projects);
    
    showToast('Projet créé avec succès', 'success');
    createProjectModal.hide();
    refreshProjectsList();
  });
  
  document.getElementById('shareProjectBtn').addEventListener('click', () => {
    if(!currentProject) return;
    
    const shareLink = `${window.location.origin}${window.location.pathname}?project=${currentProject.id}`;
    document.getElementById('shareLink').value = shareLink;
    shareProjectModal.show();
  });
  
  document.getElementById('copyShareLink').addEventListener('click', () => {
    const shareLink = document.getElementById('shareLink');
    shareLink.select();
    document.execCommand('copy');
    showToast('Lien copié dans le presse-papier', 'success');
  });
  
  document.getElementById('sendInviteBtn').addEventListener('click', () => {
    const email = document.getElementById('inviteEmail').value.trim();
    if(!validateEmail(email)) {
      showToast('Veuillez saisir un email valide', 'error');
      return;
    }
    
    // In a real app, this would send an email invitation
    const shareLink = document.getElementById('shareLink').value;
    const subject = `Invitation à rejoindre le projet: ${currentProject.name}`;
    const body = `Vous êtes invité(e) à rejoindre le projet "${currentProject.name}".\n\nCliquez sur ce lien pour accéder au projet:\n${shareLink}`;
    
    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    showToast('Invitation envoyée par email', 'success');
  });
  
  document.getElementById('backToProjectsBtn').addEventListener('click', () => {
    stopAutoSave();
    enterProjects();
  });
  
  document.getElementById('projectLogout').addEventListener('click', () => {
    showToast('Déconnexion réussie', 'success');
    setTimeout(() => location.reload(), 1000);
  });
  
  document.getElementById('gotoProjectsBtn').addEventListener('click', () => {
    enterProjects();
  });
}

function refreshProjectsList(){
  const projectsList = document.getElementById('projectsList');
  const projects = getProjects();
  
  if(projects.length === 0) {
    projectsList.innerHTML = '<div class="text-center text-muted py-4">Aucun projet. Créez votre premier projet!</div>';
    return;
  }
  
  projectsList.innerHTML = projects.map(project => `
    <div class="project-card" data-project-id="${project.id}">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <h6 class="mb-1">${escapeHtml(project.name)}</h6>
        <span class="badge bg-primary">${escapeHtml(project.type)}</span>
      </div>
      <p class="text-muted small mb-2">${escapeHtml(project.description || 'Aucune description')}</p>
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
          <i class="fas fa-calendar me-1"></i>
          ${new Date(project.createdAt).toLocaleDateString()}
        </small>
        <div>
          <button class="btn btn-sm btn-outline-primary open-project" data-project-id="${project.id}">
            <i class="fas fa-folder-open"></i> Ouvrir
          </button>
          <button class="btn btn-sm btn-outline-danger delete-project ms-1" data-project-id="${project.id}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `).join('');
  
  // Bind events
  document.querySelectorAll('.open-project').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const projectId = e.target.closest('button').dataset.projectId;
      setCurrentProject(projectId);
      enterApp();
    });
  });
  
  document.querySelectorAll('.delete-project').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const projectId = e.target.closest('button').dataset.projectId;
      const project = getProjects().find(p => p.id === projectId);
      
      if(confirm(`Êtes-vous sûr de vouloir supprimer le projet "${project.name}" ?`)) {
        const projects = getProjects().filter(p => p.id !== projectId);
        saveProjects(projects);
        refreshProjectsList();
        showToast('Projet supprimé', 'success');
      }
    });
  });
}

function refreshTeamStats(){
  const projects = getProjects();
  const users = getUsers();
  
  document.getElementById('activeProjectsCount').textContent = projects.length;
  document.getElementById('teamMembersCount').textContent = users.length;
  
  // Calculate monthly calculations (mock data)
  document.getElementById('monthlyCalculationsCount').textContent = projects.reduce((sum, p) => sum + (p.history?.length || 0), 0);
  
  // Show online team members
  const teamMembersList = document.getElementById('teamMembersList');
  if(users.length === 0) {
    teamMembersList.innerHTML = '<div class="text-center text-muted py-3">Aucun membre d\'équipe</div>';
  } else {
    teamMembersList.innerHTML = users.map(user => `
      <div class="team-member">
        <div class="online-indicator"></div>
        <div>
          <div class="fw-bold">${escapeHtml(user.name)}</div>
          <small class="text-muted">${escapeHtml(user.role)}</small>
        </div>
      </div>
    `).join('');
  }
}

// ---------------- ADMIN BIND ----------------
function bindAdmin(){
  document.getElementById('saveSettings').addEventListener('click', ()=>{
    settings.companyName = document.getElementById('settingsCompanyName').value.trim() || DEFAULT_SETTINGS.companyName;
    settings.address = document.getElementById('settingsAddress').value.trim() || DEFAULT_SETTINGS.address;
    settings.logoUrl = document.getElementById('settingsLogoUrl').value.trim() || DEFAULT_SETTINGS.logoUrl;
    settings.tva = parseFloat(document.getElementById('settingsTVA').value) || DEFAULT_SETTINGS.tva;
    settings.currency = document.getElementById('settingsCurrency').value.trim() || DEFAULT_SETTINGS.currency;
    saveSettings();
  });
  
  document.getElementById('resetSettings').addEventListener('click', ()=>{
    if(!confirm('Réinitialiser paramètres par défaut ?')) return;
    settings = {...DEFAULT_SETTINGS};
    saveSettings();
  });
  
  document.getElementById('adminLogout').addEventListener('click', ()=>{ 
    showToast('Déconnexion réussie', 'success');
    setTimeout(() => location.reload(), 1000);
  });
  
  document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
  document.getElementById('importDataBtn').addEventListener('click', () => {
    document.getElementById('importFileInput').click();
  });
  
  document.getElementById('importFileInput').addEventListener('change', importData);
}

function exportAllData(){
  const data = {
    users: getUsers(),
    projects: getProjects(),
    settings: settings,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `calculrevient-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('Données exportées avec succès', 'success');
}

function importData(e){
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = JSON.parse(event.target.result);
      
      if(confirm('Cette action va remplacer toutes les données existantes. Continuer ?')) {
        if(data.users) saveUsers(data.users);
        if(data.projects) saveProjects(data.projects);
        if(data.settings) {
          settings = {...DEFAULT_SETTINGS, ...data.settings};
          saveSettings();
        }
        
        showToast('Données importées avec succès', 'success');
        refreshUsersTable();
        setTimeout(() => location.reload(), 2000);
      }
    } catch(error) {
      showToast('Erreur lors de l\'importation du fichier', 'error');
    }
  };
  reader.readAsText(file);
}

// ---------------- USERS TABLE (admin) ----------------
function refreshUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const users = getUsers();
  
  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Aucun utilisateur enregistré</td></tr>';
    return;
  }
  
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(u.name)}</td>
      <td>${escapeHtml(u.email)}</td>
      <td><span class="badge bg-secondary">${escapeHtml(u.role)}</span></td>
      <td><button class="btn btn-sm btn-danger remove-user" data-email="${escapeHtml(u.email)}">Suppr</button></td>`;
    tbody.appendChild(tr);
  });
}

document.addEventListener('click', (e)=>{
  if(e.target && e.target.classList.contains('remove-user')){
    const email = e.target.getAttribute('data-email');
    if(!confirm(`Supprimer ${email} ?`)) return;
    let users = getUsers().filter(u=>u.email!==email);
    saveUsers(users);
    refreshUsersTable();
    showToast('Utilisateur supprimé', 'success');
  }
});

// ---------------- APP (calculation, rows, history) ----------------
function bindApp(){
  attachRowEvents(document.querySelector('#calcTable tbody tr'));
  
  document.getElementById('addRow').addEventListener('click', ()=>{
    const template = document.querySelector('#calcTable tbody tr').innerHTML;
    const tr = document.createElement('tr');
    tr.className = 'calc-row new-row';
    tr.innerHTML = template;
    attachRowEvents(tr);
    document.querySelector('#calcTable tbody').appendChild(tr);
    
    setTimeout(() => {
      tr.classList.remove('new-row');
    }, 500);
  });
  
  document.getElementById('btnCalculate').addEventListener('click', ()=>{
    document.querySelectorAll('#calcTable tbody tr').forEach(calcRow);
    saveCalculationToHistory();
    refreshProjectHistory();
    showToast('Calcul effectué et enregistré dans l\'historique.', 'success');
    showSyncStatus('Calcul synchronisé');
  });
  
  document.getElementById('saveProjectBtn').addEventListener('click', ()=>{
    saveCurrentProjectData();
    showToast('Projet sauvegardé', 'success');
    showSyncStatus('Projet sauvegardé');
  });
  
  document.getElementById('coefficient').addEventListener('input', updateFinalPrice);
  
  document.getElementById('appLogout').addEventListener('click', ()=>{ 
    stopAutoSave();
    showToast('Déconnexion réussie', 'success');
    setTimeout(() => location.reload(), 1000);
  });
  
  document.getElementById('openAdmin').addEventListener('click', ()=>{
    if(currentUser && currentUser.isAdmin) { 
      stopAutoSave();
      enterAdmin(); 
    } else { 
      showToast('Accès admin réservé. Connectez-vous en tant qu\'admin.', 'error'); 
    }
  });
  
  document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
  document.getElementById('exportExcelBtn').addEventListener('click', exportExcel);
  document.getElementById('sendMailBtn').addEventListener('click', sendMail);
  
  const clearBtn = document.getElementById('clearProjectHistory');
  if(clearBtn){
    clearBtn.addEventListener('click', ()=>{
      if(!currentUser || (!currentUser.isAdmin && currentProject.createdBy !== currentUser.id)){
        showToast('Seul l\'admin ou le créateur du projet peut effacer l\'historique.', 'error');
        return;
      }
      if(!confirm('Effacer tout l\'historique de ce projet ?')) return;
      
      if(currentProject) {
        currentProject.history = [];
        const projects = getProjects();
        const idx = projects.findIndex(p => p.id === currentProject.id);
        if(idx !== -1) {
          projects[idx] = currentProject;
          saveProjects(projects);
        }
      }
      
      refreshProjectHistory();
      showToast('Historique effacé', 'success');
    });
  }
}

function saveCurrentProjectData(){
  if(!currentProject) return;
  
  const calculations = [];
  document.querySelectorAll('#calcTable tbody tr').forEach(row => {
    const calc = {
      description: row.querySelector('.description')?.value || '',
      supplier: row.querySelector('.supplier')?.value || '',
      unit: row.querySelector('.unit')?.value || '',
      priceHT: parseFloat(row.querySelector('.price-ht')?.value) || 0,
      priceTTC: parseFloat(row.querySelector('.price-ttc')?.value) || 0,
      quantity: parseFloat(row.querySelector('.quantity')?.value) || 0,
      total: parseFloat(row.querySelector('.total')?.value) || 0,
      document: row.dataset.docName || ''
    };
    calculations.push(calc);
  });
  
  currentProject.calculations = calculations;
  currentProject.lastModified = new Date().toISOString();
  currentProject.coefficient = parseFloat(document.getElementById('coefficient').value) || 1;
  
  const projects = getProjects();
  const idx = projects.findIndex(p => p.id === currentProject.id);
  if(idx !== -1) {
    projects[idx] = currentProject;
    saveProjects(projects);
  }
}

function loadProjectData(){
  if(!currentProject || !currentProject.calculations) return;
  
  const tbody = document.querySelector('#calcTable tbody');
  tbody.innerHTML = '';
  
  if(currentProject.calculations.length === 0) {
    // Add default empty row
    const tr = document.createElement('tr');
    tr.className = 'calc-row';
    tr.innerHTML = `
      <td><input class="form-control description" placeholder="Description"></td>
      <td><input class="form-control supplier" placeholder="Fournisseur"></td>
      <td>
        <select class="form-control unit">
          <option value="">Sélectionner</option>
          <option>pièce</option><option>kg</option><option>m</option><option>m²</option><option>l</option>
        </select>
      </td>
      <td><input type="number" class="form-control price-ht" step="0.01" min="0" placeholder="0.00"></td>
      <td><input class="form-control price-ttc" readonly placeholder="0.00"></td>
      <td><input type="number" class="form-control quantity" step="0.01" min="0" placeholder="0"></td>
      <td><input class="form-control total" readonly placeholder="0.00"></td>
      <td>
        <input type="file" class="form-control form-control-sm doc-file" accept=".pdf,.jpg,.png,.jpeg">
        <div class="preview-link d-none">
          <span><i class="fas fa-check-circle doc-attached-indicator"></i><span class="file-name"></span></span>
          <i class="fas fa-times remove-doc" title="Supprimer le document"></i>
        </div>
      </td>
      <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
    `;
    attachRowEvents(tr);
    tbody.appendChild(tr);
  } else {
    currentProject.calculations.forEach(calc => {
      const tr = document.createElement('tr');
      tr.className = 'calc-row';
      tr.innerHTML = `
        <td><input class="form-control description" placeholder="Description" value="${escapeHtml(calc.description)}"></td>
        <td><input class="form-control supplier" placeholder="Fournisseur" value="${escapeHtml(calc.supplier)}"></td>
        <td>
          <select class="form-control unit">
            <option value="">Sélectionner</option>
            <option ${calc.unit === 'pièce' ? 'selected' : ''}>pièce</option>
            <option ${calc.unit === 'kg' ? 'selected' : ''}>kg</option>
            <option ${calc.unit === 'm' ? 'selected' : ''}>m</option>
            <option ${calc.unit === 'm²' ? 'selected' : ''}>m²</option>
            <option ${calc.unit === 'l' ? 'selected' : ''}>l</option>
          </select>
        </td>
        <td><input type="number" class="form-control price-ht" step="0.01" min="0" placeholder="0.00" value="${calc.priceHT}"></td>
        <td><input class="form-control price-ttc" readonly placeholder="0.00" value="${calc.priceTTC.toFixed(2)}"></td>
        <td><input type="number" class="form-control quantity" step="0.01" min="0" placeholder="0" value="${calc.quantity}"></td>
        <td><input class="form-control total" readonly placeholder="0.00" value="${calc.total.toFixed(2)}"></td>
        <td>
          <input type="file" class="form-control form-control-sm doc-file" accept=".pdf,.jpg,.png,.jpeg">
          <div class="preview-link d-none">
            <span><i class="fas fa-check-circle doc-attached-indicator"></i><span class="file-name"></span></span>
            <i class="fas fa-times remove-doc" title="Supprimer le document"></i>
          </div>
        </td>
        <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
      `;
      attachRowEvents(tr);
      tbody.appendChild(tr);
    });
  }
  
  if(currentProject.coefficient) {
    document.getElementById('coefficient').value = currentProject.coefficient;
  }
  
  calcGlobal();
  updateDocCounter();
}

function saveCalculationToHistory(){
  if(!currentProject) return;
  
  const coeff = parseFloat(document.getElementById('coefficient').value) || 1;
  const gText = document.getElementById('globalTotalSummary').textContent || '0';
  const g = parseFloat(gText.replace(/[^\d.-]/g,'')) || 0;
  const final = g * coeff;
  
  const historyEntry = {
    id: generateId(),
    date: new Date().toISOString(),
    user: currentUser ? currentUser.email : 'invité',
    userName: currentUser ? currentUser.name : 'Invité',
    totalGeneral: Number(g).toFixed(2),
    coefficient: coeff,
    finalTotal: Number(final).toFixed(2),
    calculations: currentProject.calculations || []
  };
  
  if(!currentProject.history) currentProject.history = [];
  currentProject.history.push(historyEntry);
  
  const projects = getProjects();
  const idx = projects.findIndex(p => p.id === currentProject.id);
  if(idx !== -1) {
    projects[idx] = currentProject;
    saveProjects(projects);
  }
}

// ---------------- DOCUMENTS FUNCTIONALITY ----------------
const modalEl = document.getElementById('docPreviewModal');
const previewImg = document.getElementById('docPreviewImg');
const previewInfo = document.getElementById('docPreviewInfo');
const bsModal = new bootstrap.Modal(modalEl);
const docCounterEl = document.querySelector('#docCounter .badge');

function updateDocCounter(){
  const count = Array.from(document.querySelectorAll('#calcTable tbody tr')).filter(r=>r.dataset.docName).length;
  docCounterEl.textContent = count;
  if(count > 0){
    docCounterEl.classList.remove('bg-secondary');
    docCounterEl.classList.add('bg-success');
  } else {
    docCounterEl.classList.remove('bg-success');
    docCounterEl.classList.add('bg-secondary');
  }
}

function attachRowEvents(row){
  const price = row.querySelector('.price-ht');
  const qty = row.querySelector('.quantity');
  const remove = row.querySelector('.remove-row');
  const fileInput = row.querySelector('.doc-file');
  const previewDiv = row.querySelector('.preview-link');
  const fileNameSpan = row.querySelector('.file-name');
  const removeDocBtn = row.querySelector('.remove-doc');
  const indicator = row.querySelector('.doc-attached-indicator');

  if(price) price.addEventListener('input', ()=>calcRow(row));
  if(qty) qty.addEventListener('input', ()=>calcRow(row));
  if(remove) remove.addEventListener('click', (e)=>{e.preventDefault();row.remove();calcGlobal();updateDocCounter();});

  if(fileInput) fileInput.addEventListener('change', ()=>{
    const file = fileInput.files[0];
    if(file){
      row.dataset.docName = file.name;
      const url = URL.createObjectURL(file);
      row.dataset.docUrl = url;
      fileNameSpan.textContent = file.name;
      indicator.style.display = 'inline';
      previewDiv.classList.remove('d-none');
      previewDiv.onclick = (e)=>{
        if(e.target.classList.contains('remove-doc')) return;
        if(file.type.startsWith('image/')){
          previewImg.src = url;
          previewImg.classList.remove('d-none');
          previewInfo.textContent = '';
          bsModal.show();
        } else {
          previewImg.classList.add('d-none');
          previewInfo.innerHTML = `<a href="${url}" download="${file.name}" class="btn btn-sm btn-primary mt-2">Télécharger</a>`;
          bsModal.show();
        }
      }
      updateDocCounter();
      showToast(`Document "${file.name}" ajouté`, 'success');
    } else {
      clearDoc(row);
    }
  });

  if(removeDocBtn) removeDocBtn.addEventListener('click', ()=>{
    clearDoc(row);
    updateDocCounter();
    showToast('Document supprimé', 'warning');
  });
}

function clearDoc(row){
  row.dataset.docName = '';
  row.dataset.docUrl = '';
  row.querySelector('.doc-file').value = '';
  row.querySelector('.preview-link').classList.add('d-none');
  row.querySelector('.doc-attached-indicator').style.display = 'none';
}

function calcRow(row){
  const priceHT = parseFloat(row.querySelector('.price-ht').value) || 0;
  const tvaRate = (settings.tva || DEFAULT_SETTINGS.tva)/100;
  const priceTTC = priceHT * (1 + tvaRate);
  const qty = parseFloat(row.querySelector('.quantity').value) || 0;
  const total = priceTTC * qty;
  
  row.querySelector('.price-ttc').value = priceTTC.toFixed(2);
  row.querySelector('.total').value = total.toFixed(2);
  
  calcGlobal();
}

function calcGlobal(){
  const rows = document.querySelectorAll('#calcTable tbody tr');
  let totalHT = 0;
  
  rows.forEach(r=>{
    const p = parseFloat(r.querySelector('.price-ht').value) || 0;
    const q = parseFloat(r.querySelector('.quantity').value) || 0;
    totalHT += p * q;
  });
  
  const tva = (settings.tva||DEFAULT_SETTINGS.tva)/100;
  const totalTVA = totalHT * tva;
  const totalTTC = totalHT + totalTVA;
  
  document.getElementById('sumHT').textContent = Number(totalHT).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('sumTVA').textContent = Number(totalTVA).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('sumTTC').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('globalTotalCell').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('globalTotalSummary').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  
  updateFinalPrice();
}

function updateFinalPrice(){
  const coeff = parseFloat(document.getElementById('coefficient').value) || 1;
  const gText = document.getElementById('globalTotalSummary').textContent || '0';
  const g = parseFloat(gText.replace(/[^\d.-]/g,'')) || 0;
  const final = g * coeff;
  
  document.getElementById('finalPrice').textContent = Number(final).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
}

let chartLine = null, chartPie = null;

function refreshProjectHistory(){
  if(!currentProject) return;
  
  const hist = currentProject.history || [];
  const tbody = document.querySelector('#historyTable tbody');
  
  if(tbody){
    tbody.innerHTML = '';
    
    if (hist.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Aucun historique disponible</td></tr>';
    } else {
      hist.slice().reverse().forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(h.date).toLocaleString()}</td>
          <td>${escapeHtml(h.userName || h.user)}</td>
          <td>${escapeHtml(h.totalGeneral)} ${settings.currency||DEFAULT_SETTINGS.currency}</td>
          <td>${escapeHtml(String(h.coefficient))}</td>
          <td>${escapeHtml(h.finalTotal)} ${settings.currency||DEFAULT_SETTINGS.currency}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary restore-calculation" data-history-id="${h.id}">
              <i class="fas fa-undo"></i> Restaurer
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
  
  // Bind restore events
  document.querySelectorAll('.restore-calculation').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const historyId = e.target.closest('button').dataset.historyId;
      const historyEntry = hist.find(h => h.id === historyId);
      
      if(historyEntry && confirm('Restaurer ce calcul ? Les données actuelles seront remplacées.')) {
        currentProject.calculations = historyEntry.calculations || [];
        currentProject.coefficient = historyEntry.coefficient || 1;
        loadProjectData();
        showToast('Calcul restauré', 'success');
      }
    });
  });
  
  try{
    const dates = hist.map(h=>new Date(h.date).toLocaleDateString());
    const finals = hist.map(h=>Number(h.finalTotal));
    const ctxLine = document.getElementById('chartLine');
    
    if (ctxLine) {
      if(chartLine) chartLine.destroy();
      
      if (hist.length > 0) {
        chartLine = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Prix final',
              data: finals,
              tension: 0.25,
              fill: true,
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderColor: 'rgba(52, 152, 219, 1)',
              pointBackgroundColor: 'rgba(52, 152, 219, 1)'
            }]
          },
          options: { 
            responsive: true, 
            plugins: { 
              legend: {
                display: true 
              } 
            }, 
            scales: { 
              x: { 
                display: true,
                ticks: {
                  maxTicksLimit: 6
                }
              }, 
              y: { 
                beginAtZero: true 
              } 
            } 
          }
        });
      } else {
        ctxLine.innerHTML = '<p class="text-center text-muted py-4">Aucune donnée à afficher</p>';
      }
    }
    
    const byUser = {};
    hist.forEach(h => { byUser[h.userName || h.user] = (byUser[h.userName || h.user]||0) + Number(h.finalTotal); });
    const users = Object.keys(byUser);
    const values = users.map(u=>byUser[u]);
    const colors = users.map((_,i)=>`hsl(${(i*60)%360} 70% 55%)`);
    const ctxPie = document.getElementById('chartPie');
    
    if (ctxPie) {
      if(chartPie) chartPie.destroy();
      
      if (users.length > 0) {
        chartPie = new Chart(ctxPie, {
          type: 'pie',
          data: { 
            labels: users, 
            datasets: [{ 
              data: values, 
              backgroundColor: colors 
            }] 
          },
          options: { 
            responsive: true, 
            plugins: { 
              legend: {
                position: 'right'
              } 
            } 
          }
        });
      } else {
        ctxPie.innerHTML = '<p class="text-center text-muted py-4">Aucune donnée à afficher</p>';
      }
    }
  } catch(err) { 
    console.warn('Erreur chart', err); 
  }
}

function refreshProjectTeam(){
  if(!currentProject) return;
  
  const teamList = document.getElementById('projectTeamList');
  const users = getUsers();
  const teamMembers = users.filter(u => currentProject.team && currentProject.team.includes(u.id));
  
  if(teamMembers.length === 0) {
    teamList.innerHTML = '<div class="text-center text-muted py-3">Aucun membre dans ce projet</div>';
    return;
  }
  
  teamList.innerHTML = teamMembers.map(member => `
    <div class="team-member">
      <div class="online-indicator"></div>
      <div class="flex-grow-1">
        <div class="fw-bold">${escapeHtml(member.name)}</div>
        <small class="text-muted">${escapeHtml(member.email)} • ${escapeHtml(member.role)}</small>
      </div>
      ${currentUser.isAdmin || currentProject.createdBy === currentUser.id ? `
        <button class="btn btn-sm btn-outline-danger remove-team-member" data-user-id="${member.id}">
          <i class="fas fa-user-minus"></i>
        </button>
      ` : ''}
    </div>
  `).join('');
  
  // Bind remove team member events
  document.querySelectorAll('.remove-team-member').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const userId = e.target.closest('button').dataset.userId;
      const user = users.find(u => u.id === userId);
      
      if(confirm(`Retirer ${user.name} de ce projet ?`)) {
        currentProject.team = currentProject.team.filter(id => id !== userId);
        const projects = getProjects();
        const idx = projects.findIndex(p => p.id === currentProject.id);
        if(idx !== -1) {
          projects[idx] = currentProject;
          saveProjects(projects);
        }
        refreshProjectTeam();
        showToast('Membre retiré du projet', 'success');
      }
    });
  });
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  
  doc.setFontSize(12);
  doc.text(settings.companyName || DEFAULT_SETTINGS.companyName, 40, 50);
  doc.text(settings.address || DEFAULT_SETTINGS.address, 40, 66);
  doc.text(`Projet: ${currentProject ? currentProject.name : 'Nouveau Calcul'}`, 40, 82);
  doc.text('Calcul de revient - ' + (new Date()).toLocaleString(), 40, 98);
  
  const rows = [];
  document.querySelectorAll('#calcTable tbody tr').forEach(r=>{
    const desc = r.querySelector('.description')?.value || '';
    const supplier = r.querySelector('.supplier')?.value || '';
    const unit = r.querySelector('.unit')?.value || '';
    const pHT = Number(r.querySelector('.price-ht')?.value || 0).toFixed(2);
    const pTTC = r.querySelector('.price-ttc')?.value || '0.00';
    const qty = r.querySelector('.quantity')?.value || '0';
    const total = r.querySelector('.total')?.value || '0.00';
    const docName = r.dataset.docName || '';
    rows.push([desc, supplier, unit, pHT, pTTC, qty, total, docName]);
  });
  
  doc.autoTable({
    head: [['Description','Fournisseur','Unité','Prix HT','Prix TTC','Quantité','Total','Document']],
    body: rows,
    startY: 120,
    styles: { fontSize: 9 }
  });
  
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 130;
  doc.text(`Total HT: ${document.getElementById('sumHT').textContent}`, 40, finalY);
  doc.text(`TVA: ${document.getElementById('sumTVA').textContent}`, 40, finalY + 16);
  doc.text(`Total TTC: ${document.getElementById('sumTTC').textContent}`, 40, finalY + 32);
  doc.text(`Prix final: ${document.getElementById('finalPrice').textContent}`, 40, finalY + 48);
  
  const fileName = currentProject ? `${currentProject.name.replace(/[^a-zA-Z0-9]/g, '_')}_calcul.pdf` : 'calcul_revient.pdf';
  doc.save(fileName);
  showToast('PDF exporté avec succès', 'success');
}

function exportExcel(){
  const data = [];
  const headers = ['Description','Fournisseur','Unité','Prix HT','Prix TTC','Quantité','Total','Document'];
  data.push(headers);
  
  document.querySelectorAll('#calcTable tbody tr').forEach(r => {
    data.push([
      r.querySelector('.description')?.value || '',
      r.querySelector('.supplier')?.value || '',
      r.querySelector('.unit')?.value || '',
      Number(r.querySelector('.price-ht')?.value || 0),
      Number(r.querySelector('.price-ttc')?.value || 0),
      Number(r.querySelector('.quantity')?.value || 0),
      Number(r.querySelector('.total')?.value || 0),
      r.dataset.docName || ''
    ]);
  });
  
  data.push([]);
  data.push(['Total HT','','','','','','',document.getElementById('sumHT').textContent]);
  data.push(['TVA','','','','','','',document.getElementById('sumTVA').textContent]);
  data.push(['Total TTC','','','','','','',document.getElementById('sumTTC').textContent]);
  data.push(['Prix final','','','','','','',document.getElementById('finalPrice').textContent]);
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'CalculRevient');
  
  const fileName = currentProject ? `${currentProject.name.replace(/[^a-zA-Z0-9]/g, '_')}_calcul.xlsx` : 'calcul-revient.xlsx';
  XLSX.writeFile(wb, fileName);
  showToast('Fichier Excel exporté avec succès', 'success');
}

function sendMail(){
  let body = `Société: ${settings.companyName}\nAdresse: ${settings.address}\n`;
  if(currentProject) {
    body += `Projet: ${currentProject.name}\n`;
  }
  body += `\nRésumé:\n`;
  body += `Total HT: ${document.getElementById('sumHT').textContent}\n`;
  body += `TVA: ${document.getElementById('sumTVA').textContent}\n`;
  body += `Total TTC: ${document.getElementById('sumTTC').textContent}\n`;
  body += `Prix final: ${document.getElementById('finalPrice').textContent}\n\nDétails:\n`;
  
  document.querySelectorAll('#calcTable tbody tr').forEach(r=>{
    const desc = r.querySelector('.description')?.value || '';
    const supplier = r.querySelector('.supplier')?.value || '';
    const unit = r.querySelector('.unit')?.value || '';
    const pHT = r.querySelector('.price-ht')?.value || '';
    const pTTC = r.querySelector('.price-ttc')?.value || '';
    const qty = r.querySelector('.quantity')?.value || '';
    const total = r.querySelector('.total')?.value || '';
    const docName = r.dataset.docName ? `[Document: ${r.dataset.docName}]` : '';
    body += `${desc} | ${supplier} | ${unit} | HT:${pHT} | TTC:${pTTC} | q:${qty} | total:${total} ${docName}\n`;
  });
  
  const subject = currentProject ? `Calcul de revient - ${currentProject.name}` : 'Calcul de revient';
  window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

function updateSummaryDisplay(){
  ['sumHT','sumTVA','sumTTC','globalTotalCell','globalTotalSummary','finalPrice'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const n = parseFloat(el.textContent.replace(/[^\d.-]/g,'')) || 0;
    el.textContent = n.toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  });
}

// Check for shared project on page load
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const sharedProjectId = urlParams.get('project');
  
  if(sharedProjectId) {
    // Auto-login for shared projects (in a real app, this would be handled differently)
    showToast('Accès au projet partagé. Veuillez vous connecter.', 'info');
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
