<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CalculRevientTN - Application Fusionnée</title>

<!-- CSS / libs -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary: #2c3e50;
  --accent: #3498db;
  --secondary: #6a11cb;
  --success: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
  --bg: #f5f7fa;
  --card-bg: #ffffff;
  --text: #333333;
  --text-light: #7f8c8d;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  --gradient: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
  --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  --gradient-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

* {
  transition: all 0.3s ease;
}

body {
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  padding: 12px;
  font-family: 'Segoe UI', Inter, Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
}

.loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.auth-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px 0;
}

.auth-card {
  max-width: 480px;
  width: 100%;
  margin: 20px auto;
  padding: 0;
  background: var(--card-bg);
  border-radius: 18px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.auth-header {
  background: var(--gradient);
  color: #fff;
  padding: 18px 24px 12px 24px;
  display: flex;
  align-items: center;
  gap: 1.5rem;
  border-bottom: 1px solid rgba(0,0,0,0.07);
}

.auth-header .company-logo {
  height: 56px;
  width: 56px;
  object-fit: contain;
  background: #fff;
  padding: 6px;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.auth-header .flag {
  height: 35px;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.10);
}

.auth-content {
  padding: 28px 28px 18px 28px;
}

.app-header {
  background: var(--gradient);
  color: #fff;
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 24px;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.company-logo {
  height: 56px;
  object-fit: contain;
  background: #fff;
  padding: 6px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.10);
}

.flag {
  height: 44px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.10);
}

.panel {
  background: var(--card-bg);
  padding: 22px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  border: none;
  transition: box-shadow 0.2s, transform 0.2s;
}

.panel:hover {
  box-shadow: 0 8px 32px rgba(52, 152, 219, 0.10);
  transform: translateY(-2px);
}

.btn {
  border-radius: 50px;
  padding: 10px 20px;
  font-weight: 600;
  transition: all 0.3s;
  border: none;
}

.btn-primary { 
  background: var(--gradient); 
}

.btn-primary:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.btn-success { 
  background: var(--gradient-success);
}

.btn-danger { 
  background: var(--gradient-danger);
}

.table { 
  border-radius: 8px; 
  overflow: hidden; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
}

.form-control { 
  border-radius: 8px; 
  padding: 10px 15px; 
  border: 1px solid #ddd; 
  transition: all 0.3s;
}

.form-control:focus { 
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.18); 
  border-color: var(--accent);
}

.form-control.is-invalid {
  border-color: var(--danger);
}

.nav-tabs .nav-link { 
  border-radius: 8px 8px 0 0; 
  padding: 12px 20px; 
  font-weight: 600; 
  color: var(--text-light);
}

.nav-tabs .nav-link.active { 
  background: var(--card-bg); 
  border-bottom: none; 
  color: var(--primary);
}

.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

.calc-row {
  transition: all 0.3s;
}

.calc-row:hover {
  background-color: rgba(52, 152, 219, 0.05);
}

.calc-row:has(.form-control:focus) {
  background-color: rgba(52, 152, 219, 0.08);
}

.remove-row {
  opacity: 0.7;
  transition: all 0.3s;
}

.remove-row:hover {
  opacity: 1;
  transform: scale(1.1);
}

@media (max-width: 768px) {
  .auth-card { 
    margin: 16px auto; 
  }
  
  .app-header { 
    padding: 12px;
    flex-direction: column;
    text-align: center;
    gap: 15px;
  }
  
  .company-logo { 
    height: 40px;
  }
  
  .auth-header {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
    padding: 15px;
  }
  
  .app-header > div {
    width: 100%;
    justify-content: center !important;
  }
  
  .table-responsive {
    font-size: 0.85rem;
  }
  
  .btn {
    padding: 8px 16px;
    font-size: 0.9rem;
  }
}

/* Animation pour les nouvelles lignes */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.new-row {
  animation: fadeIn 0.5s ease;
}

/* Styles pour les indicateurs de chargement */
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Styles pour les notifications toast */
.toast {
  background: var(--card-bg);
  border-left: 4px solid var(--accent);
  box-shadow: var(--shadow);
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--danger);
}

.toast.warning {
  border-left-color: var(--warning);
}
</style>
</head>
<body>

<!-- Loading indicator -->
<div class="loading" id="loadingIndicator" style="display: none;">
  <div class="spinner"></div>
</div>

<!-- Toast notifications container -->
<div class="toast-container" id="toastContainer"></div>

<!-- AUTH VIEW -->
<div id="authView">
  <div class="auth-container">
    <div class="auth-card" id="loginCard">
      <div class="auth-header">
        <img src="logo.png" alt="Logo" class="company-logo" id="loginLogo">
        <div>
          <div style="font-size:1.35rem;font-weight:700;" id="loginCompanyName">Société Exemple SARL</div>
          <div style="font-size:0.95rem;opacity:.9;" id="loginCompanyAddress">12 Rue de Tunis, 1000 Tunis</div>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
      </div>
      <div class="auth-content">
        <h4 class="mb-4 text-center"><i class="fas fa-lock me-2"></i> Connexion</h4>
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="loginEmail" type="email" class="form-control" required>
            <div class="invalid-feedback">Veuillez saisir un email valide</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mot de passe</label>
            <input id="loginPassword" type="password" class="form-control" required>
            <div class="invalid-feedback">Le mot de passe est requis</div>
          </div>
          <div class="mb-3 small text-center">
            <a href="#" id="showRegisterLink">Créer un compte</a> &nbsp;|&nbsp;
            <a href="#" id="forgotPassLink">Mot de passe oublié</a>
          </div>
          <button class="btn btn-primary w-100 mt-2" type="submit" id="loginBtn">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
            Se connecter
          </button>
        </form>
      </div>
    </div>
    
    <div class="auth-card" id="registerCard" style="display:none;">
      <div class="auth-header">
        <img src="logo.png" alt="Logo" class="company-logo" id="registerLogo">
        <div>
          <div style="font-size:1.35rem;font-weight:700;" id="registerCompanyName">Société Exemple SARL</div>
          <div style="font-size:0.95rem;opacity:.9;" id="registerCompanyAddress">12 Rue de Tunis, 1000 Tunis</div>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
      </div>
      <div class="auth-content">
        <h4 class="mb-4 text-center"><i class="fas fa-user-plus me-2"></i> Créer un compte</h4>
        <form id="registerForm">
          <div class="mb-3">
            <label>Nom</label>
            <input id="regName" class="form-control" required>
            <div class="invalid-feedback">Veuillez saisir votre nom</div>
          </div>
          <div class="mb-3">
            <label>Email</label>
            <input id="regEmail" type="email" class="form-control" required>
            <div class="invalid-feedback">Veuillez saisir un email valide</div>
          </div>
          <div class="mb-3">
            <label>Mot de passe</label>
            <input id="regPassword" type="password" class="form-control" required minlength="6">
            <div class="invalid-feedback">Le mot de passe doit contenir au moins 6 caractères</div>
          </div>
          <div class="d-flex justify-content-between">
            <button id="cancelRegister" class="btn btn-outline-secondary">Annuler</button>
            <button class="btn btn-success" type="submit" id="registerBtn">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
              Créer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div id="mainApp" style="display:none;">
  <!-- Header -->
  <div class="app-header">
    <div class="d-flex align-items-center gap-3">
      <img id="companyLogo" src="logo.png" class="company-logo" alt="Logo">
      <div>
        <div id="companyName" style="font-weight:700;font-size:1.2rem;">Société Exemple SARL</div>
        <div id="companyAddress" style="font-size:0.95rem;opacity:.9">12 Rue de Tunis, 1000 Tunis</div>
      </div>
    </div>
    <div class="text-end">
      <div style="font-size:0.95rem;opacity:.9">Conforme - TVA <span id="showTVA">19</span>%</div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div id="adminPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-user-shield me-2"></i> Panneau Admin</h3>
      <div>
        <button id="gotoAppBtn" class="btn btn-outline-primary me-2">Aller à l'application</button>
        <button id="adminLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="panel">
          <h5 class="mb-3">Paramètres modifiables</h5>
          <div class="mb-3">
            <label>Nom société</label>
            <input id="settingsCompanyName" class="form-control">
          </div>
          <div class="mb-3">
            <label>Adresse</label>
            <input id="settingsAddress" class="form-control">
          </div>
          <div class="mb-3">
            <label>Logo (URL ou fichier local)</label>
            <input id="settingsLogoUrl" class="form-control" placeholder="logo.png ou https://...">
          </div>
          <div class="mb-3">
            <label>TVA (%)</label>
            <input id="settingsTVA" type="number" class="form-control" min="0" step="0.01">
          </div>
          <div class="mb-3">
            <label>Devise</label>
            <input id="settingsCurrency" class="form-control">
          </div>
          <div class="d-flex gap-2">
            <button id="saveSettings" class="btn btn-primary">Enregistrer</button>
            <button id="resetSettings" class="btn btn-outline-secondary">Réinitialiser</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="panel">
          <h5 class="mb-3">Utilisateurs enregistrés</h5>
          <div class="table-responsive">
            <table class="table table-sm" id="usersTable">
              <thead><tr><th>Nom</th><th>Email</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <small class="text-muted">Supprime un utilisateur si nécessaire.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- APP PAGE -->
  <div id="appPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-calculator me-2"></i> Application de calcul</h3>
      <div>
        <span id="currentUserLabel" class="me-3 small text-muted"></span>
        <button id="openAdmin" class="btn btn-outline-secondary me-2" title="Accès admin (admin seulement)"><i class="fas fa-user-cog"></i></button>
        <button id="appLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabCalc">Calcul</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabHistory">Historique</a></li>
    </ul>

    <div class="tab-content mt-4">
      <!-- Calcul Tab -->
      <div id="tabCalc" class="tab-pane fade show active">
        <div class="row">
          <div class="col-md-8">
            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-table me-2"></i> Tableau de calcul</h5>
                <div>
                  <button id="addRow" class="btn btn-primary btn-sm me-2"><i class="fas fa-plus"></i> Ajouter</button>
                  <button id="btnCalculate" class="btn btn-success btn-sm"><i class="fas fa-calculator"></i> Calculer</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-bordered calculation-table" id="calcTable">
                  <thead>
                    <tr>
                      <th>Description</th>
                      <th>Fournisseur</th>
                      <th>Unité</th>
                      <th>Prix HT</th>
                      <th>Prix TTC</th>
                      <th>Quantité</th>
                      <th>Total</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="calc-row new-row">
                      <td><input class="form-control description" placeholder="Description"></td>
                      <td><input class="form-control supplier" placeholder="Fournisseur"></td>
                      <td>
                        <select class="form-control unit">
                          <option value="">Sélectionner</option>
                          <option>pièce</option><option>kg</option><option>m</option><option>m²</option><option>l</option>
                        </select>
                      </td>
                      <td><input type="number" class="form-control price-ht" step="0.01" min="0" placeholder="0.00"></td>
                      <td><input class="form-control price-ttc" readonly placeholder="0.00"></td>
                      <td><input type="number" class="form-control quantity" step="0.01" min="0" placeholder="0"></td>
                      <td><input class="form-control total" readonly placeholder="0.00"></td>
                      <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="6" class="text-end fw-bold">Total général :</td>
                      <td id="globalTotalCell" class="fw-bold">0.00</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="panel">
              <h6 class="mb-3">Résumé</h6>
              <div class="d-flex justify-content-between mb-2"><span>Total HT:</span><span id="sumHT">0.00</span></div>
              <div class="d-flex justify-content-between mb-2"><span>TVA (<span id="showTVA2">19</span>%)</span><span id="sumTVA">0.00</span></div>
              <div class="d-flex justify-content-between mb-2"><span>Total TTC:</span><span id="sumTTC">0.00</span></div>
              <hr>
              <div class="d-flex justify-content-between fw-bold mb-3"><span>Total général:</span><span id="globalTotalSummary">0.00</span></div>
              <div class="mb-3">
                <label>Coefficient</label>
                <input id="coefficient" type="number" step="0.01" min="0" class="form-control" value="1">
              </div>
              <div class="d-flex justify-content-between fw-bold"><span>Prix final:</span><span id="finalPrice">0.00</span></div>
            </div>
            <div class="panel">
              <button id="exportPdfBtn" class="btn btn-outline-primary w-100 mb-2"><i class="fas fa-file-pdf"></i> Exporter (PDF)</button>
              <button id="exportExcelBtn" class="btn btn-outline-success w-100 mb-2"><i class="fas fa-file-excel"></i> Exporter (Excel)</button>
              <button id="sendMailBtn" class="btn btn-outline-danger w-100"><i class="fas fa-envelope"></i> Envoyer par mail</button>
            </div>
          </div>
        </div>
      </div>
      <!-- History Tab -->
      <div id="tabHistory" class="tab-pane fade">
        <div class="panel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-history me-2"></i> Historique</h5>
            <div>
              <button id="clearHistory" class="btn btn-outline-danger btn-sm">Effacer historique</button>
            </div>
          </div>
          <div class="table-responsive mb-4">
            <table class="table table-sm table-bordered" id="historyTable">
              <thead><tr><th>Date</th><th>Utilisateur</th><th>Total général</th><th>Coeff</th><th>Prix final</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="row">
            <div class="col-md-7">
              <canvas id="chartLine"></canvas>
            </div>
            <div class="col-md-5">
              <canvas id="chartPie"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Forgot modal -->
<div class="modal fade" id="forgotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="forgotForm" class="p-3">
        <div class="modal-header"><h5 class="modal-title">Mot de passe oublié</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label>Email</label><input id="forgotEmail" type="email" class="form-control" required></div>
          <div class="mb-3"><label>Nouveau mot de passe</label><input id="forgotNewPass" type="password" class="form-control" required minlength="6"></div>
          <small class="text-muted">Si l'email existe (non-admin), le mot de passe sera mis à jour.</small>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button type="submit" class="btn btn-primary">Réinitialiser</button></div>
      </form>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// --------- Config / Storage keys ---------
const ADMIN_EMAIL = 'omri.sami@ymail.com';
const ADMIN_PASS = '21111989Ss**';
const KEY_USERS = 'cr_users_fusion';
const KEY_SETTINGS = 'cr_settings_fusion';
const KEY_HISTORY = 'cr_history_fusion';

const DEFAULT_SETTINGS = {
  companyName: 'Hensol Tunisia',
  address: 'Ben Arous TN',
  logoUrl: 'logo.png',
  tva: 19,
  currency: 'TND'
};

let settings = {...DEFAULT_SETTINGS};
let currentUser = null; // {name,email,isAdmin}

// --------- Helpers storage ---------
function loadSettings(){
  try{
    const raw = localStorage.getItem(KEY_SETTINGS);
    if(raw) settings = Object.assign({}, DEFAULT_SETTINGS, JSON.parse(raw));
    else settings = {...DEFAULT_SETTINGS};
  }catch(e){ settings = {...DEFAULT_SETTINGS}; }
  applySettingsToUI();

  // Synchronisation page de connexion & inscription
  document.getElementById('loginCompanyName').textContent = settings.companyName || '';
  document.getElementById('loginCompanyAddress').textContent = settings.address || '';
  document.getElementById('loginLogo').src = settings.logoUrl || 'logo.png';
  document.getElementById('registerCompanyName').textContent = settings.companyName || '';
  document.getElementById('registerCompanyAddress').textContent = settings.address || '';
  document.getElementById('registerLogo').src = settings.logoUrl || 'logo.png';
}

function saveSettings(){ 
  localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); 
  applySettingsToUI(); 
  showToast('Paramètres sauvegardés avec succès', 'success');
}

function getUsers(){ 
  try{ 
    return JSON.parse(localStorage.getItem(KEY_USERS) || '[]'); 
  }catch(e){ 
    return []; 
  } 
}

function saveUsers(u){ 
  localStorage.setItem(KEY_USERS, JSON.stringify(u)); 
}

function getHistory(){ 
  try{ 
    return JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]'); 
  }catch(e){ 
    return []; 
  } 
}

function saveHistory(h){ 
  localStorage.setItem(KEY_HISTORY, JSON.stringify(h)); 
}

// --------- UI shortcuts ---------
const loginCard = document.getElementById('loginCard');
const registerCard = document.getElementById('registerCard');
const authView = document.getElementById('authView');
const mainApp = document.getElementById('mainApp');
const adminPage = document.getElementById('adminPage');
const appPage = document.getElementById('appPage');

// --------- Utility functions ---------
function escapeHtml(s){ 
  return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); 
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type} mb-2`;
  toast.innerHTML = `
    <div class="toast-body d-flex justify-content-between">
      <span>${message}</span>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
  `;
  document.getElementById('toastContainer').appendChild(toast);
  
  const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
  bsToast.show();
  
  // Remove toast from DOM after it's hidden
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

function showLoading(show) {
  document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

// --------- Init on DOM ready ---------
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  bindAuth();
  bindAdmin();
  bindApp();
  refreshUsersTable();
  refreshHistoryUI();
  updateSummaryDisplay();
});

// ---------------- AUTH ----------------
function bindAuth(){
  document.getElementById('showRegisterLink').addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    loginCard.style.display='none'; 
    registerCard.style.display='block'; 
  });
  
  document.getElementById('cancelRegister').addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    registerCard.style.display='none'; 
    loginCard.style.display='block'; 
  });
  
  document.getElementById('registerForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim().toLowerCase();
    const pass = document.getElementById('regPassword').value;
    
    // Validation
    let isValid = true;
    if(!name) {
      document.getElementById('regName').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regName').classList.remove('is-invalid');
    }
    
    if(!validateEmail(email)) {
      document.getElementById('regEmail').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regEmail').classList.remove('is-invalid');
    }
    
    if(!pass || pass.length < 6) {
      document.getElementById('regPassword').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('regPassword').classList.remove('is-invalid');
    }
    
    if(!isValid) {
      showToast('Veuillez corriger les erreurs dans le formulaire', 'error');
      return;
    }
    
    if(email === ADMIN_EMAIL){
      showToast('Email réservé (admin)', 'error');
      return;
    }
    
    const users = getUsers();
    if(users.some(u=>u.email===email)){
      showToast('Email déjà utilisé', 'error');
      return;
    }
    
    // Show loading
    const registerBtn = document.getElementById('registerBtn');
    const spinner = registerBtn.querySelector('.spinner-border');
    spinner.style.display = 'inline-block';
    registerBtn.disabled = true;
    
    // Simulate async operation
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    users.push({name, email, password: pass});
    saveUsers(users);
    
    // Hide loading
    spinner.style.display = 'none';
    registerBtn.disabled = false;
    
    showToast('Compte créé — connectez-vous.', 'success');
    document.getElementById('registerForm').reset();
    registerCard.style.display='none'; 
    loginCard.style.display='block';
    refreshUsersTable();
  });
  
  document.getElementById('loginForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pass = document.getElementById('loginPassword').value;
    
    // Validation
    let isValid = true;
    if(!validateEmail(email)) {
      document.getElementById('loginEmail').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('loginEmail').classList.remove('is-invalid');
    }
    
    if(!pass) {
      document.getElementById('loginPassword').classList.add('is-invalid');
      isValid = false;
    } else {
      document.getElementById('loginPassword').classList.remove('is-invalid');
    }
    
    if(!isValid) {
      showToast('Veuillez corriger les erreurs dans le formulaire', 'error');
      return;
    }
    
    // Show loading
    const loginBtn = document.getElementById('loginBtn');
    const spinner = loginBtn.querySelector('.spinner-border');
    spinner.style.display = 'inline-block';
    loginBtn.disabled = true;
    
    // Simulate async operation
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if(email === ADMIN_EMAIL && pass === ADMIN_PASS){
      currentUser = {name: 'Admin', email: ADMIN_EMAIL, isAdmin: true};
      
      // Hide loading
      spinner.style.display = 'none';
      loginBtn.disabled = false;
      
      enterAdmin();
      return;
    }
    
    const users = getUsers();
    const u = users.find(x => x.email === email && x.password === pass);
    
    if(!u){ 
      // Hide loading
      spinner.style.display = 'none';
      loginBtn.disabled = false;
      
      showToast('Email ou mot de passe incorrect', 'error'); 
      return; 
    }
    
    currentUser = {name: u.name, email: u.email, isAdmin: false};
    
    // Hide loading
    spinner.style.display = 'none';
    loginBtn.disabled = false;
    
    enterApp();
  });
  
  const forgotModalEl = document.getElementById('forgotModal');
  const bsForgot = new bootstrap.Modal(forgotModalEl);
  
  document.getElementById('forgotPassLink').addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    document.getElementById('forgotForm').reset(); 
    bsForgot.show(); 
  });
  
  document.getElementById('forgotForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
    const newPass = document.getElementById('forgotNewPass').value;
    
    if(email === ADMIN_EMAIL){ 
      showToast("Impossible de réinitialiser le mot de passe admin ici.", 'error'); 
      return; 
    }
    
    if(!newPass || newPass.length < 6) {
      showToast("Le mot de passe doit contenir au moins 6 caractères", 'error');
      return;
    }
    
    const users = getUsers();
    const idx = users.findIndex(u=>u.email===email);
    if(idx === -1){ 
      showToast("Email non trouvé.", 'error'); 
      return; 
    }
    
    users[idx].password = newPass;
    saveUsers(users);
    showToast('Mot de passe mis à jour.', 'success');
    bsForgot.hide();
  });
}

// ---------------- ENTER ADMIN / APP ----------------
function applySettingsToUI(){
  document.getElementById('companyLogo').src = settings.logoUrl || 'logo.png';
  document.getElementById('companyName').textContent = settings.companyName || '';
  document.getElementById('companyAddress').textContent = settings.address || '';
  document.getElementById('showTVA').textContent = settings.tva;
  document.getElementById('showTVA2').textContent = settings.tva;
  
  if(document.getElementById('settingsCompanyName')) document.getElementById('settingsCompanyName').value = settings.companyName;
  if(document.getElementById('settingsAddress')) document.getElementById('settingsAddress').value = settings.address;
  if(document.getElementById('settingsLogoUrl')) document.getElementById('settingsLogoUrl').value = settings.logoUrl;
  if(document.getElementById('settingsTVA')) document.getElementById('settingsTVA').value = settings.tva;
  if(document.getElementById('settingsCurrency')) document.getElementById('settingsCurrency').value = settings.currency || DEFAULT_SETTINGS.currency;
  
  updateSummaryDisplay();
}

function enterAdmin(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='';
  appPage.style.display='none';
  document.getElementById('currentUserLabel').textContent = 'Admin';
  refreshUsersTable();
  updateHistoryControls();
}

function enterApp(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='none';
  appPage.style.display='';
  document.getElementById('currentUserLabel').textContent = currentUser ? `${currentUser.name} (${currentUser.email})` : '';
  refreshHistoryUI();
  updateHistoryControls();
}

// ---------------- ADMIN BIND ----------------
function bindAdmin(){
  document.getElementById('saveSettings').addEventListener('click', ()=>{
    settings.companyName = document.getElementById('settingsCompanyName').value.trim() || DEFAULT_SETTINGS.companyName;
    settings.address = document.getElementById('settingsAddress').value.trim() || DEFAULT_SETTINGS.address;
    settings.logoUrl = document.getElementById('settingsLogoUrl').value.trim() || DEFAULT_SETTINGS.logoUrl;
    settings.tva = parseFloat(document.getElementById('settingsTVA').value) || DEFAULT_SETTINGS.tva;
    settings.currency = document.getElementById('settingsCurrency').value.trim() || DEFAULT_SETTINGS.currency;
    saveSettings();
  });
  
  document.getElementById('resetSettings').addEventListener('click', ()=>{
    if(!confirm('Réinitialiser paramètres par défaut ?')) return;
    settings = {...DEFAULT_SETTINGS};
    saveSettings();
  });
  
  document.getElementById('adminLogout').addEventListener('click', ()=>{ 
    showToast('Déconnexion réussie', 'success');
    setTimeout(() => location.reload(), 1000);
  });
  
  document.getElementById('gotoAppBtn')?.addEventListener('click', ()=>{ 
    adminPage.style.display='none'; 
    appPage.style.display=''; 
    updateHistoryControls(); 
  });
}

// ---------------- USERS TABLE (admin) ----------------
function refreshUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const users = getUsers();
  
  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Aucun utilisateur enregistré</td></tr>';
    return;
  }
  
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td>
      <td><button class="btn btn-sm btn-danger remove-user" data-email="${escapeHtml(u.email)}">Suppr</button></td>`;
    tbody.appendChild(tr);
  });
}

document.addEventListener('click', (e)=>{
  if(e.target && e.target.classList.contains('remove-user')){
    const email = e.target.getAttribute('data-email');
    if(!confirm(`Supprimer ${email} ?`)) return;
    let users = getUsers().filter(u=>u.email!==email);
    saveUsers(users);
    refreshUsersTable();
    showToast('Utilisateur supprimé', 'success');
  }
});

// ---------------- APP (calculation, rows, history) ----------------
function bindApp(){
  attachRowEvents(document.querySelector('#calcTable tbody tr'));
  
  document.getElementById('addRow').addEventListener('click', ()=>{
    const template = document.querySelector('#calcTable tbody tr').innerHTML;
    const tr = document.createElement('tr');
    tr.className = 'calc-row new-row';
    tr.innerHTML = template;
    attachRowEvents(tr);
    document.querySelector('#calcTable tbody').appendChild(tr);
    
    // Remove animation class after animation completes
    setTimeout(() => {
      tr.classList.remove('new-row');
    }, 500);
  });
  
  document.getElementById('btnCalculate').addEventListener('click', ()=>{
    document.querySelectorAll('#calcTable tbody tr').forEach(calcRow);
    saveHistoryEntry();
    refreshHistoryUI();
    showToast('Calcul effectué et enregistré dans l’historique.', 'success');
  });
  
  document.getElementById('coefficient').addEventListener('input', updateFinalPrice);
  
  document.getElementById('appLogout').addEventListener('click', ()=>{ 
    showToast('Déconnexion réussie', 'success');
    setTimeout(() => location.reload(), 1000);
  });
  
  document.getElementById('openAdmin').addEventListener('click', ()=>{
    if(currentUser && currentUser.isAdmin) { 
      enterAdmin(); 
    } else { 
      showToast('Accès admin réservé. Connectez-vous en tant qu’admin.', 'error'); 
    }
  });
  
  document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
  document.getElementById('exportExcelBtn').addEventListener('click', exportExcel);
  document.getElementById('sendMailBtn').addEventListener('click', sendMail);
  
  const clearBtn = document.getElementById('clearHistory');
  if(clearBtn){
    clearBtn.addEventListener('click', ()=>{
      if(!currentUser || !currentUser.isAdmin){
        showToast('Seul l\'admin peut effacer l\'historique.', 'error');
        return;
      }
      if(!confirm('Effacer tout l’historique ?')) return;
      saveHistory([]);
      refreshHistoryUI();
      showToast('Historique effacé', 'success');
    });
  }
}

function attachRowEvents(row){
  const price = row.querySelector('.price-ht');
  const qty = row.querySelector('.quantity');
  const remove = row.querySelector('.remove-row');
  
  if(price) price.addEventListener('input', ()=>calcRow(row));
  if(qty) qty.addEventListener('input', ()=>calcRow(row));
  if(remove) remove.addEventListener('click', (e)=>{ 
    e.preventDefault(); 
    
    // Add fade out animation
    row.style.opacity = '0';
    row.style.transition = 'opacity 0.3s';
    
    setTimeout(() => {
      row.remove(); 
      calcGlobal();
    }, 300);
  });
}

function calcRow(row){
  const priceHT = parseFloat(row.querySelector('.price-ht').value) || 0;
  const tvaRate = (settings.tva || DEFAULT_SETTINGS.tva)/100;
  const priceTTC = priceHT * (1 + tvaRate);
  const qty = parseFloat(row.querySelector('.quantity').value) || 0;
  const total = priceTTC * qty;
  
  row.querySelector('.price-ttc').value = priceTTC.toFixed(2);
  row.querySelector('.total').value = total.toFixed(2);
  
  calcGlobal();
}

function calcGlobal(){
  const rows = document.querySelectorAll('#calcTable tbody tr');
  let totalHT = 0;
  
  rows.forEach(r=>{
    const p = parseFloat(r.querySelector('.price-ht').value) || 0;
    const q = parseFloat(r.querySelector('.quantity').value) || 0;
    totalHT += p * q;
  });
  
  const tva = (settings.tva||DEFAULT_SETTINGS.tva)/100;
  const totalTVA = totalHT * tva;
  const totalTTC = totalHT + totalTVA;
  
  document.getElementById('sumHT').textContent = Number(totalHT).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('sumTVA').textContent = Number(totalTVA).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('sumTTC').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('globalTotalCell').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('globalTotalSummary').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  
  updateFinalPrice();
}

function updateFinalPrice(){
  const coeff = parseFloat(document.getElementById('coefficient').value) || 1;
  const gText = document.getElementById('globalTotalSummary').textContent || '0';
  const g = parseFloat(gText.replace(/[^\d.-]/g,'')) || 0;
  const final = g * coeff;
  
  document.getElementById('finalPrice').textContent = Number(final).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
}

function saveHistoryEntry(){
  const coeff = parseFloat(document.getElementById('coefficient').value) || 1;
  const gText = document.getElementById('globalTotalSummary').textContent || '0';
  const g = parseFloat(gText.replace(/[^\d.-]/g,'')) || 0;
  const final = g * coeff;
  
  const hist = getHistory();
  hist.push({
    date: new Date().toLocaleString(),
    user: currentUser ? currentUser.email : 'invité',
    totalGeneral: Number(g).toFixed(2),
    coefficient: coeff,
    finalTotal: Number(final).toFixed(2)
  });
  
  saveHistory(hist);
}

let chartLine = null, chartPie = null;

function refreshHistoryUI(){
  const hist = getHistory() || [];
  const tbody = document.querySelector('#historyTable tbody');
  
  if(tbody){
    tbody.innerHTML = '';
    
    if (hist.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Aucun historique disponible</td></tr>';
    } else {
      hist.slice().reverse().forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(h.date)}</td><td>${escapeHtml(h.user)}</td><td>${escapeHtml(h.totalGeneral)} ${settings.currency||DEFAULT_SETTINGS.currency}</td><td>${escapeHtml(String(h.coefficient))}</td><td>${escapeHtml(h.finalTotal)} ${settings.currency||DEFAULT_SETTINGS.currency}</td>`;
        tbody.appendChild(tr);
      });
    }
  }
  
  try{
    const dates = hist.map(h=>h.date);
    const finals = hist.map(h=>Number(h.finalTotal));
    const ctxLine = document.getElementById('chartLine');
    
    if (ctxLine) {
      if(chartLine) chartLine.destroy();
      
      if (hist.length > 0) {
        chartLine = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [{
              label: 'Prix final',
              data: finals,
              tension: 0.25,
              fill: true,
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderColor: 'rgba(52, 152, 219, 1)',
              pointBackgroundColor: 'rgba(52, 152, 219, 1)'
            }]
          },
          options: { 
            responsive: true, 
            plugins: { 
              legend: {
                display: true 
              } 
            }, 
            scales: { 
              x: { 
                display: true,
                ticks: {
                  maxTicksLimit: 6
                }
              }, 
              y: { 
                beginAtZero: true 
              } 
            } 
          }
        });
      } else {
        ctxLine.innerHTML = '<p class="text-center text-muted py-4">Aucune donnée à afficher</p>';
      }
    }
    
    const byUser = {};
    hist.forEach(h => { byUser[h.user] = (byUser[h.user]||0) + Number(h.finalTotal); });
    const users = Object.keys(byUser);
    const values = users.map(u=>byUser[u]);
    const colors = users.map((_,i)=>`hsl(${(i*60)%360} 70% 55%)`);
    const ctxPie = document.getElementById('chartPie');
    
    if (ctxPie) {
      if(chartPie) chartPie.destroy();
      
      if (users.length > 0) {
        chartPie = new Chart(ctxPie, {
          type: 'pie',
          data: { 
            labels: users, 
            datasets: [{ 
              data: values, 
              backgroundColor: colors 
            }] 
          },
          options: { 
            responsive: true, 
            plugins: { 
              legend: {
                position: 'right'
              } 
            } 
          }
        });
      } else {
        ctxPie.innerHTML = '<p class="text-center text-muted py-4">Aucune donnée à afficher</p>';
      }
    }
  } catch(err) { 
    console.warn('Erreur chart', err); 
  }
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  
  doc.setFontSize(12);
  doc.text(settings.companyName || DEFAULT_SETTINGS.companyName, 40, 50);
  doc.text(settings.address || DEFAULT_SETTINGS.address, 40, 66);
  doc.text('Calcul de revient - ' + (new Date()).toLocaleString(), 40, 86);
  
  const rows = [];
  document.querySelectorAll('#calcTable tbody tr').forEach(r=>{
    const desc = r.querySelector('.description')?.value || '';
    const supplier = r.querySelector('.supplier')?.value || '';
    const unit = r.querySelector('.unit')?.value || '';
    const pHT = Number(r.querySelector('.price-ht')?.value || 0).toFixed(2);
    const pTTC = r.querySelector('.price-ttc')?.value || '0.00';
    const qty = r.querySelector('.quantity')?.value || '0';
    const total = r.querySelector('.total')?.value || '0.00';
    rows.push([desc, supplier, unit, pHT, pTTC, qty, total]);
  });
  
  doc.autoTable({
    head: [['Description','Fournisseur','Unité','Prix HT','Prix TTC','Quantité','Total']],
    body: rows,
    startY: 110,
    styles: { fontSize: 9 }
  });
  
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 120;
  doc.text(`Total HT: ${document.getElementById('sumHT').textContent}`, 40, finalY);
  doc.text(`TVA: ${document.getElementById('sumTVA').textContent}`, 40, finalY + 16);
  doc.text(`Total TTC: ${document.getElementById('sumTTC').textContent}`, 40, finalY + 32);
  doc.text(`Prix final: ${document.getElementById('finalPrice').textContent}`, 40, finalY + 48);
  
  doc.save('calcul_revient.pdf');
  showToast('PDF exporté avec succès', 'success');
}

function exportExcel(){
  const data = [];
  const headers = ['Description','Fournisseur','Unité','Prix HT','Prix TTC','Quantité','Total'];
  data.push(headers);
  
  document.querySelectorAll('#calcTable tbody tr').forEach(r => {
    data.push([
      r.querySelector('.description')?.value || '',
      r.querySelector('.supplier')?.value || '',
      r.querySelector('.unit')?.value || '',
      Number(r.querySelector('.price-ht')?.value || 0),
      Number(r.querySelector('.price-ttc')?.value || 0),
      Number(r.querySelector('.quantity')?.value || 0),
      Number(r.querySelector('.total')?.value || 0)
    ]);
  });
  
  data.push([]);
  data.push(['Total HT','','','','','',document.getElementById('sumHT').textContent]);
  data.push(['TVA','','','','','',document.getElementById('sumTVA').textContent]);
  data.push(['Total TTC','','','','','',document.getElementById('sumTTC').textContent]);
  data.push(['Prix final','','','','','',document.getElementById('finalPrice').textContent]);
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'CalculRevient');
  XLSX.writeFile(wb, 'calcul-revient.xlsx');
  showToast('Fichier Excel exporté avec succès', 'success');
}

function sendMail(){
  let body = `Société: ${settings.companyName}\nAdresse: ${settings.address}\n\nRésumé:\n`;
  body += `Total HT: ${document.getElementById('sumHT').textContent}\n`;
  body += `TVA: ${document.getElementById('sumTVA').textContent}\n`;
  body += `Total TTC: ${document.getElementById('sumTTC').textContent}\n`;
  body += `Prix final: ${document.getElementById('finalPrice').textContent}\n\nDétails:\n`;
  
  document.querySelectorAll('#calcTable tbody tr').forEach(r=>{
    const desc = r.querySelector('.description')?.value || '';
    const supplier = r.querySelector('.supplier')?.value || '';
    const unit = r.querySelector('.unit')?.value || '';
    const pHT = r.querySelector('.price-ht')?.value || '';
    const pTTC = r.querySelector('.price-ttc')?.value || '';
    const qty = r.querySelector('.quantity')?.value || '';
    const total = r.querySelector('.total')?.value || '';
    body += `${desc} | ${supplier} | ${unit} | HT:${pHT} | TTC:${pTTC} | q:${qty} | total:${total}\n`;
  });
  
  window.location.href = `mailto:?subject=${encodeURIComponent('Calcul de revient')}&body=${encodeURIComponent(body)}`;
}

function updateSummaryDisplay(){
  ['sumHT','sumTVA','sumTTC','globalTotalCell','globalTotalSummary','finalPrice'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const n = parseFloat(el.textContent.replace(/[^\d.-]/g,'')) || 0;
    el.textContent = n.toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  });
}

function updateHistoryControls(){
  const btn = document.getElementById('clearHistory');
  if(!btn) return;
  
  if(currentUser && currentUser.isAdmin){
    btn.style.display = '';
    btn.disabled = false;
  } else {
    btn.style.display = 'none';
    btn.disabled = true;
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
