<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CalculRevientTN - Application Fusionnée</title>

<!-- CSS / libs -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  --primary: #2c3e50;
  --accent: #3498db;
  --secondary: #6a11cb;
  --success: #27ae60;
  --bg: #f5f7fa;
  --card-bg: #ffffff;
  --text: #333333;
  --text-light: #7f8c8d;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  --gradient: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
}

body {
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  padding: 12px;
  font-family: 'Segoe UI', Inter, Tahoma, Geneva, Verdana, sans-serif;
}

/* Cartes d'authentification */
.auth-card {
  max-width: 460px;
  margin: 50px auto;
  padding: 30px;
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

/* En-tête d'application */
.app-header {
  background: var(--gradient);
  color: #fff;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}

.company-logo {
  height: 60px;
  object-fit: contain;
  background: #fff;
  padding: 6px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Panels et cartes */
.panel {
  background: var(--card-bg);
  padding: 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  border: none;
}

.calculation-table th {
  background: var(--primary);
  color: #fff;
}

.flag {
  height: 44px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Boutons */
.btn {
  border-radius: 50px;
  padding: 10px 20px;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
}

.btn-primary { background: var(--gradient); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15);}
.btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);}
.btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }

.table { border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.form-control { border-radius: 8px; padding: 10px 15px; border: 1px solid #ddd; transition: all 0.3s;}
.form-control:focus { box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); border-color: var(--accent);}
.nav-tabs .nav-link { border-radius: 8px 8px 0 0; padding: 12px 20px; font-weight: 600; color: var(--text-light);}
.nav-tabs .nav-link.active { background: var(--card-bg); border-bottom: none; color: var(--primary);}
.feature-card { transition: transform 0.3s;}
.feature-card:hover { transform: translateY(-5px);}
@media (max-width: 768px) {
  .auth-card { margin: 20px auto; padding: 20px;}
  .app-header { padding: 12px;}
  .company-logo { height: 50px;}
}
</style>
</head>
<body>

<!-- AUTH VIEW -->
<div id="authView">
  <div class="auth-card" id="loginCard">
    <h4 class="mb-4"><i class="fas fa-lock me-2"></i> Connexion</h4>
    <form id="loginForm">
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="loginEmail" type="email" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Mot de passe</label>
        <input id="loginPassword" type="password" class="form-control" required>
      </div>
      <div class="mb-3 small">
        <a href="#" id="showRegisterLink">Créer un compte</a> &nbsp;|&nbsp;
        <a href="#" id="forgotPassLink">Mot de passe oublié</a>
      </div>
      <button class="btn btn-primary w-100" type="submit">Se connecter</button>
    </form>
  </div>

  <div class="auth-card" id="registerCard" style="display:none;">
    <h4 class="mb-4"><i class="fas fa-user-plus me-2"></i> Créer un compte</h4>
    <form id="registerForm">
      <div class="mb-3">
        <label>Nom</label>
        <input id="regName" class="form-control" required>
      </div>
      <div class="mb-3">
        <label>Email</label>
        <input id="regEmail" type="email" class="form-control" required>
      </div>
      <div class="mb-3">
        <label>Mot de passe</label>
        <input id="regPassword" type="password" class="form-control" required>
      </div>
      <div class="d-flex justify-content-between">
        <button id="cancelRegister" class="btn btn-outline-secondary">Annuler</button>
        <button class="btn btn-success" type="submit">Créer</button>
      </div>
    </form>
  </div>
</div>

<!-- MAIN APP (hidden until login) -->
<div id="mainApp" style="display:none;">
  <!-- Header -->
  <div class="app-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <img id="companyLogo" src="logo.png" class="company-logo" alt="Logo">
      <div>
        <div id="companyName" style="font-weight:700">Société Exemple SARL</div>
        <div id="companyAddress" style="font-size:0.9rem;opacity:.9">12 Rue de Tunis, 1000 Tunis</div>
      </div>
    </div>
    <div class="text-end">
      <div style="font-size:0.9rem;opacity:.9">Conforme - TVA <span id="showTVA">19</span>%</div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" class="flag" alt="Tunisie">
    </div>
  </div>

  <!-- ADMIN PAGE -->
  <div id="adminPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-user-shield me-2"></i> Panneau Admin</h3>
      <div>
        <button id="gotoAppBtn" class="btn btn-outline-primary me-2">Aller à l'application</button>
        <button id="adminLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="panel">
          <h5 class="mb-3">Paramètres modifiables</h5>
          <div class="mb-3">
            <label>Nom société</label>
            <input id="settingsCompanyName" class="form-control">
          </div>
          <div class="mb-3">
            <label>Adresse</label>
            <input id="settingsAddress" class="form-control">
          </div>
          <div class="mb-3">
            <label>Logo (URL ou fichier local)</label>
            <input id="settingsLogoUrl" class="form-control" placeholder="logo.png ou https://...">
          </div>
          <div class="mb-3">
            <label>TVA (%)</label>
            <input id="settingsTVA" type="number" class="form-control" min="0" step="0.01">
          </div>
          <div class="mb-3">
            <label>Devise</label>
            <input id="settingsCurrency" class="form-control">
          </div>
          <div class="d-flex gap-2">
            <button id="saveSettings" class="btn btn-primary">Enregistrer</button>
            <button id="resetSettings" class="btn btn-outline-secondary">Réinitialiser</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="panel">
          <h5 class="mb-3">Utilisateurs enregistrés</h5>
          <table class="table table-sm" id="usersTable">
            <thead><tr><th>Nom</th><th>Email</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
          <small class="text-muted">Supprime un utilisateur si nécessaire.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- APP PAGE -->
  <div id="appPage" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-calculator me-2"></i> Application de calcul</h3>
      <div>
        <span id="currentUserLabel" class="me-3 small text-muted"></span>
        <button id="openAdmin" class="btn btn-outline-secondary me-2" title="Accès admin (admin seulement)"><i class="fas fa-user-cog"></i></button>
        <button id="appLogout" class="btn btn-danger">Déconnexion</button>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabCalc">Calcul</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabHistory">Historique</a></li>
    </ul>

    <div class="tab-content mt-4">
      <!-- Calcul Tab -->
      <div id="tabCalc" class="tab-pane fade show active">
        <div class="row">
          <div class="col-md-8">
            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-table me-2"></i> Tableau de calcul</h5>
                <div>
                  <button id="addRow" class="btn btn-primary btn-sm me-2"><i class="fas fa-plus"></i> Ajouter</button>
                  <button id="btnCalculate" class="btn btn-success btn-sm"><i class="fas fa-calculator"></i> Calculer</button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-bordered calculation-table" id="calcTable">
                  <thead>
                    <tr>
                      <th>Description</th>
                      <th>Fournisseur</th>
                      <th>Unité</th>
                      <th>Prix HT</th>
                      <th>Prix TTC</th>
                      <th>Quantité</th>
                      <th>Total</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><input class="form-control description"></td>
                      <td><input class="form-control supplier"></td>
                      <td>
                        <select class="form-control unit">
                          <option>pièce</option><option>kg</option><option>m</option><option>m²</option><option>l</option>
                        </select>
                      </td>
                      <td><input type="number" class="form-control price-ht" step="0.01" min="0"></td>
                      <td><input class="form-control price-ttc" readonly></td>
                      <td><input type="number" class="form-control quantity" step="0.01" min="0"></td>
                      <td><input class="form-control total" readonly></td>
                      <td><button class="btn btn-sm btn-danger remove-row"><i class="fas fa-trash"></i></button></td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="6" class="text-end fw-bold">Total général :</td>
                      <td id="globalTotalCell" class="fw-bold">0.00</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="panel">
              <h6 class="mb-3">Résumé</h6>
              <div class="d-flex justify-content-between mb-2"><span>Total HT:</span><span id="sumHT">0.00</span></div>
              <div class="d-flex justify-content-between mb-2"><span>TVA (<span id="showTVA2">19</span>%)</span><span id="sumTVA">0.00</span></div>
              <div class="d-flex justify-content-between mb-2"><span>Total TTC:</span><span id="sumTTC">0.00</span></div>
              <hr>
              <div class="d-flex justify-content-between fw-bold mb-3"><span>Total général:</span><span id="globalTotalSummary">0.00</span></div>
              <div class="mb-3">
                <label>Coefficient</label>
                <input id="coefficient" type="number" step="0.01" min="0" class="form-control" value="1">
              </div>
              <div class="d-flex justify-content-between fw-bold"><span>Prix final:</span><span id="finalPrice">0.00</span></div>
            </div>
            <div class="panel">
              <button id="exportPdfBtn" class="btn btn-outline-primary w-100 mb-2"><i class="fas fa-file-pdf"></i> Exporter (PDF)</button>
              <button id="exportExcelBtn" class="btn btn-outline-success w-100 mb-2"><i class="fas fa-file-excel"></i> Exporter (Excel)</button>
              <button id="sendMailBtn" class="btn btn-outline-danger w-100"><i class="fas fa-envelope"></i> Envoyer par mail</button>
            </div>
          </div>
        </div>
      </div>
      <!-- History Tab -->
      <div id="tabHistory" class="tab-pane fade">
        <div class="panel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-history me-2"></i> Historique</h5>
            <div>
              <button id="clearHistory" class="btn btn-outline-danger btn-sm">Effacer historique</button>
            </div>
          </div>
          <div class="table-responsive mb-4">
            <table class="table table-sm table-bordered" id="historyTable">
              <thead><tr><th>Date</th><th>Utilisateur</th><th>Total général</th><th>Coeff</th><th>Prix final</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="row">
            <div class="col-md-7">
              <canvas id="chartLine"></canvas>
            </div>
            <div class="col-md-5">
              <canvas id="chartPie"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Forgot modal -->
<div class="modal fade" id="forgotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="forgotForm" class="p-3">
        <div class="modal-header"><h5 class="modal-title">Mot de passe oublié</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label>Email</label><input id="forgotEmail" type="email" class="form-control" required></div>
          <div class="mb-3"><label>Nouveau mot de passe</label><input id="forgotNewPass" type="password" class="form-control" required></div>
          <small class="text-muted">Si l'email existe (non-admin), le mot de passe sera mis à jour.</small>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button type="submit" class="btn btn-primary">Réinitialiser</button></div>
      </form>
    </div>
  </div>
</div>

<script>
// --------- Config / Storage keys ---------
const ADMIN_EMAIL = 'omri.sami@ymail.com';
const ADMIN_PASS = '21111989Ss**';
const KEY_USERS = 'cr_users_fusion';
const KEY_SETTINGS = 'cr_settings_fusion';
const KEY_HISTORY = 'cr_history_fusion';

const DEFAULT_SETTINGS = {
  companyName: 'Hensol Tunisia',
  address: 'Ben Arous TN',
  logoUrl: '"C:\Users\sami.omri\OneDrive - CATANA GROUP\Bureau\application\logo.png.png"',
  tva: 19,
  currency: 'TND'
};

let settings = {...DEFAULT_SETTINGS};
let currentUser = null; // {name,email,isAdmin}

// --------- Helpers storage ---------
function loadSettings(){
  try{
    const raw = localStorage.getItem(KEY_SETTINGS);
    if(raw) settings = Object.assign({}, DEFAULT_SETTINGS, JSON.parse(raw));
    else settings = {...DEFAULT_SETTINGS};
  }catch(e){ settings = {...DEFAULT_SETTINGS}; }
  applySettingsToUI();
}
function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); applySettingsToUI(); }
function getUsers(){ try{ return JSON.parse(localStorage.getItem(KEY_USERS) || '[]'); }catch(e){ return []; } }
function saveUsers(u){ localStorage.setItem(KEY_USERS, JSON.stringify(u)); }
function getHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]'); }catch(e){ return []; } }
function saveHistory(h){ localStorage.setItem(KEY_HISTORY, JSON.stringify(h)); }

// --------- UI shortcuts ---------
const loginCard = document.getElementById('loginCard');
const registerCard = document.getElementById('registerCard');
const authView = document.getElementById('authView');
const mainApp = document.getElementById('mainApp');
const adminPage = document.getElementById('adminPage');
const appPage = document.getElementById('appPage');

// --------- Init on DOM ready ---------
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  bindAuth();
  bindAdmin();
  bindApp();
  refreshUsersTable();
  refreshHistoryUI();
  updateSummaryDisplay();
});

// ---------------- AUTH ----------------
function bindAuth(){
  document.getElementById('showRegisterLink').addEventListener('click', (e)=>{ e.preventDefault(); loginCard.style.display='none'; registerCard.style.display='block'; });
  document.getElementById('cancelRegister').addEventListener('click', (e)=>{ e.preventDefault(); registerCard.style.display='none'; loginCard.style.display='block'; });
  document.getElementById('registerForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim().toLowerCase();
    const pass = document.getElementById('regPassword').value;
    if(!name || !email || !pass){ alert('Remplis tous les champs'); return; }
    if(email === ADMIN_EMAIL){ alert('Email réservé (admin)'); return; }
    const users = getUsers();
    if(users.some(u=>u.email===email)){ alert('Email déjà utilisé'); return; }
    users.push({name, email, password: pass});
    saveUsers(users);
    alert('Compte créé — connecte-toi.');
    document.getElementById('registerForm').reset();
    registerCard.style.display='none'; loginCard.style.display='block';
    refreshUsersTable();
  });
  document.getElementById('loginForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pass = document.getElementById('loginPassword').value;
    if(email === ADMIN_EMAIL && pass === ADMIN_PASS){
      currentUser = {name: 'Admin', email: ADMIN_EMAIL, isAdmin: true};
      enterAdmin();
      return;
    }
    const users = getUsers();
    const u = users.find(x => x.email === email && x.password === pass);
    if(!u){ alert('Email ou mot de passe incorrect'); return; }
    currentUser = {name: u.name, email: u.email, isAdmin: false};
    enterApp();
  });
  const forgotModalEl = document.getElementById('forgotModal');
  const bsForgot = new bootstrap.Modal(forgotModalEl);
  document.getElementById('forgotPassLink').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('forgotForm').reset(); bsForgot.show(); });
  document.getElementById('forgotForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
    const newPass = document.getElementById('forgotNewPass').value;
    if(email === ADMIN_EMAIL){ alert("Impossible de réinitialiser le mot de passe admin ici."); return; }
    const users = getUsers();
    const idx = users.findIndex(u=>u.email===email);
    if(idx === -1){ alert("Email non trouvé."); return; }
    users[idx].password = newPass;
    saveUsers(users);
    alert('Mot de passe mis à jour.');
    bsForgot.hide();
  });
}

// ---------------- ENTER ADMIN / APP ----------------
function applySettingsToUI(){
  document.getElementById('companyLogo').src = settings.logoUrl || 'logo.png';
  document.getElementById('companyName').textContent = settings.companyName || '';
  document.getElementById('companyAddress').textContent = settings.address || '';
  document.getElementById('showTVA').textContent = settings.tva;
  document.getElementById('showTVA2').textContent = settings.tva;
  if(document.getElementById('settingsCompanyName')) document.getElementById('settingsCompanyName').value = settings.companyName;
  if(document.getElementById('settingsAddress')) document.getElementById('settingsAddress').value = settings.address;
  if(document.getElementById('settingsLogoUrl')) document.getElementById('settingsLogoUrl').value = settings.logoUrl;
  if(document.getElementById('settingsTVA')) document.getElementById('settingsTVA').value = settings.tva;
  if(document.getElementById('settingsCurrency')) document.getElementById('settingsCurrency').value = settings.currency || DEFAULT_SETTINGS.currency;
  updateSummaryDisplay();
}
function enterAdmin(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='';
  appPage.style.display='none';
  document.getElementById('currentUserLabel').textContent = 'Admin';
  refreshUsersTable();
  updateHistoryControls();
}
function enterApp(){
  authView.style.display='none';
  mainApp.style.display='';
  adminPage.style.display='none';
  appPage.style.display='';
  document.getElementById('currentUserLabel').textContent = currentUser ? `${currentUser.name} (${currentUser.email})` : '';
  refreshHistoryUI();
  updateHistoryControls();
}

// ---------------- ADMIN BIND ----------------
function bindAdmin(){
  document.getElementById('saveSettings').addEventListener('click', ()=>{
    settings.companyName = document.getElementById('settingsCompanyName').value.trim() || DEFAULT_SETTINGS.companyName;
    settings.address = document.getElementById('settingsAddress').value.trim() || DEFAULT_SETTINGS.address;
    settings.logoUrl = document.getElementById('settingsLogoUrl').value.trim() || DEFAULT_SETTINGS.logoUrl;
    settings.tva = parseFloat(document.getElementById('settingsTVA').value) || DEFAULT_SETTINGS.tva;
    settings.currency = document.getElementById('settingsCurrency').value.trim() || DEFAULT_SETTINGS.currency;
    saveSettings();
    alert('Paramètres sauvegardés.');
  });
  document.getElementById('resetSettings').addEventListener('click', ()=>{
    if(!confirm('Réinitialiser paramètres par défaut ?')) return;
    settings = {...DEFAULT_SETTINGS};
    saveSettings();
    alert('Paramètres réinitialisés.');
  });
  document.getElementById('adminLogout').addEventListener('click', ()=>{ location.reload(); });
  document.getElementById('gotoAppBtn')?.addEventListener('click', ()=>{ adminPage.style.display='none'; appPage.style.display=''; updateHistoryControls(); });
}

// ---------------- USERS TABLE (admin) ----------------
function refreshUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const users = getUsers();
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td>
      <td><button class="btn btn-sm btn-danger remove-user" data-email="${escapeHtml(u.email)}">Suppr</button></td>`;
    tbody.appendChild(tr);
  });
}
document.addEventListener('click', (e)=>{
  if(e.target && e.target.classList.contains('remove-user')){
    const email = e.target.getAttribute('data-email');
    if(!confirm(`Supprimer ${email} ?`)) return;
    let users = getUsers().filter(u=>u.email!==email);
    saveUsers(users);
    refreshUsersTable();
  }
});

// ---------------- APP (calculation, rows, history) ----------------
function bindApp(){
  attachRowEvents(document.querySelector('#calcTable tbody tr'));
  document.getElementById('addRow').addEventListener('click', ()=>{
    const template = document.querySelector('#calcTable tbody tr').innerHTML;
    const tr = document.createElement('tr');
    tr.innerHTML = template;
    attachRowEvents(tr);
    document.querySelector('#calcTable tbody').appendChild(tr);
  });
  document.getElementById('btnCalculate').addEventListener('click', ()=>{
    document.querySelectorAll('#calcTable tbody tr').forEach(calcRow);
    saveHistoryEntry();
    refreshHistoryUI();
    alert('Calcul effectué et enregistré dans l’historique.');
  });
  document.getElementById('coefficient').addEventListener('input', updateFinalPrice);
  document.getElementById('appLogout').addEventListener('click', ()=>{ location.reload(); });
  document.getElementById('openAdmin').addEventListener('click', ()=>{
    if(currentUser && currentUser.isAdmin) { enterAdmin(); }
    else { alert('Accès admin réservé. Connecte-toi en tant qu’admin.'); }
  });
  document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
  document.getElementById('exportExcelBtn').addEventListener('click', exportExcel);
  document.getElementById('sendMailBtn').addEventListener('click', sendMail);
  const clearBtn = document.getElementById('clearHistory');
  if(clearBtn){
    clearBtn.addEventListener('click', ()=>{
      if(!currentUser || !currentUser.isAdmin){
        alert('Seul l\'admin peut effacer l\'historique.');
        return;
      }
      if(!confirm('Effacer tout l’historique ?')) return;
      saveHistory([]);
      refreshHistoryUI();
    });
  }
}
function attachRowEvents(row){
  const price = row.querySelector('.price-ht');
  const qty = row.querySelector('.quantity');
  const remove = row.querySelector('.remove-row');
  if(price) price.addEventListener('input', ()=>calcRow(row));
  if(qty) qty.addEventListener('input', ()=>calcRow(row));
  if(remove) remove.addEventListener('click', (e)=>{ e.preventDefault(); row.remove(); calcGlobal(); });
}
function calcRow(row){
  const priceHT = parseFloat(row.querySelector('.price-ht').value) || 0;
  const tvaRate = (settings.tva || DEFAULT_SETTINGS.tva)/100;
  const priceTTC = priceHT * (1 + tvaRate);
  const qty = parseFloat(row.querySelector('.quantity').value) || 0;
  const total = priceTTC * qty;
  row.querySelector('.price-ttc').value = priceTTC.toFixed(2);
  row.querySelector('.total').value = total.toFixed(2);
  calcGlobal();
}
function calcGlobal(){
  const rows = document.querySelectorAll('#calcTable tbody tr');
  let totalHT = 0;
  rows.forEach(r=>{
    const p = parseFloat(r.querySelector('.price-ht').value) || 0;
    const q = parseFloat(r.querySelector('.quantity').value) || 0;
    totalHT += p * q;
  });
  const tva = (settings.tva||DEFAULT_SETTINGS.tva)/100;
  const totalTVA = totalHT * tva;
  const totalTTC = totalHT + totalTVA;
  document.getElementById('sumHT').textContent = Number(totalHT).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('sumTVA').textContent = Number(totalTVA).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('sumTTC').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('globalTotalCell').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  document.getElementById('globalTotalSummary').textContent = Number(totalTTC).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  updateFinalPrice();
}
function updateFinalPrice(){
  const coeff = parseFloat(document.getElementById('coefficient').value) || 1;
  const gText = document.getElementById('globalTotalSummary').textContent || '0';
  const g = parseFloat(gText.replace(/[^\d.-]/g,'')) || 0;
  const final = g * coeff;
  document.getElementById('finalPrice').textContent = Number(final).toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
}
function saveHistoryEntry(){
  const coeff = parseFloat(document.getElementById('coefficient').value) || 1;
  const gText = document.getElementById('globalTotalSummary').textContent || '0';
  const g = parseFloat(gText.replace(/[^\d.-]/g,'')) || 0;
  const final = g * coeff;
  const hist = getHistory();
  hist.push({
    date: new Date().toLocaleString(),
    user: currentUser ? currentUser.email : 'invité',
    totalGeneral: Number(g).toFixed(2),
    coefficient: coeff,
    finalTotal: Number(final).toFixed(2)
  });
  saveHistory(hist);
}
let chartLine = null, chartPie = null;
function refreshHistoryUI(){
  const hist = getHistory() || [];
  const tbody = document.querySelector('#historyTable tbody');
  if(tbody){
    tbody.innerHTML = '';
    hist.slice().reverse().forEach(h=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(h.date)}</td><td>${escapeHtml(h.user)}</td><td>${escapeHtml(h.totalGeneral)}</td><td>${escapeHtml(String(h.coefficient))}</td><td>${escapeHtml(h.finalTotal)}</td>`;
      tbody.appendChild(tr);
    });
  }
  try{
    const dates = hist.map(h=>h.date);
    const finals = hist.map(h=>Number(h.finalTotal));
    const ctxLine = document.getElementById('chartLine').getContext('2d');
    if(chartLine) chartLine.destroy();
    chartLine = new Chart(ctxLine, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Prix final',
          data: finals,
          tension: 0.25,
          fill: true
        }]
      },
      options: { responsive: true, plugins: { legend:{display:true} }, scales: { x:{ display: true }, y:{ beginAtZero:true } } }
    });
    const byUser = {};
    hist.forEach(h => { byUser[h.user] = (byUser[h.user]||0) + Number(h.finalTotal); });
    const users = Object.keys(byUser);
    const values = users.map(u=>byUser[u]);
    const colors = users.map((_,i)=>`hsl(${(i*60)%360} 70% 55%)`);
    const ctxPie = document.getElementById('chartPie').getContext('2d');
    if(chartPie) chartPie.destroy();
    chartPie = new Chart(ctxPie, {
      type: 'pie',
      data: { labels: users, datasets:[{ data: values, backgroundColor: colors }] },
      options: { responsive: true, plugins:{ legend:{position:'right'} } }
    });
  }catch(err){ console.warn('Erreur chart', err); }
}
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  doc.setFontSize(12);
  doc.text(settings.companyName || DEFAULT_SETTINGS.companyName, 40, 50);
  doc.text(settings.address || DEFAULT_SETTINGS.address, 40, 66);
  doc.text('Calcul de revient - ' + (new Date()).toLocaleString(), 40, 86);
  const rows = [];
  document.querySelectorAll('#calcTable tbody tr').forEach(r=>{
    const desc = r.querySelector('.description')?.value || '';
    const supplier = r.querySelector('.supplier')?.value || '';
    const unit = r.querySelector('.unit')?.value || '';
    const pHT = Number(r.querySelector('.price-ht')?.value || 0).toFixed(2);
    const pTTC = r.querySelector('.price-ttc')?.value || '0.00';
    const qty = r.querySelector('.quantity')?.value || '0';
    const total = r.querySelector('.total')?.value || '0.00';
    rows.push([desc, supplier, unit, pHT, pTTC, qty, total]);
  });
  doc.autoTable({
    head: [['Description','Fournisseur','Unité','Prix HT','Prix TTC','Quantité','Total']],
    body: rows,
    startY: 110,
    styles: { fontSize: 9 }
  });
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 120;
  doc.text(`Total HT: ${document.getElementById('sumHT').textContent}`, 40, finalY);
  doc.text(`TVA: ${document.getElementById('sumTVA').textContent}`, 40, finalY + 16);
  doc.text(`Total TTC: ${document.getElementById('sumTTC').textContent}`, 40, finalY + 32);
  doc.text(`Prix final: ${document.getElementById('finalPrice').textContent}`, 40, finalY + 48);
  doc.save('calcul_revient.pdf');
}
function exportExcel(){
  const data = [];
  const headers = ['Description','Fournisseur','Unité','Prix HT','Prix TTC','Quantité','Total'];
  data.push(headers);
  document.querySelectorAll('#calcTable tbody tr').forEach(r => {
    data.push([
      r.querySelector('.description')?.value || '',
      r.querySelector('.supplier')?.value || '',
      r.querySelector('.unit')?.value || '',
      Number(r.querySelector('.price-ht')?.value || 0),
      Number(r.querySelector('.price-ttc')?.value || 0),
      Number(r.querySelector('.quantity')?.value || 0),
      Number(r.querySelector('.total')?.value || 0)
    ]);
  });
  data.push([]);
  data.push(['Total HT','','','','','',document.getElementById('sumHT').textContent]);
  data.push(['TVA','','','','','',document.getElementById('sumTVA').textContent]);
  data.push(['Total TTC','','','','','',document.getElementById('sumTTC').textContent]);
  data.push(['Prix final','','','','','',document.getElementById('finalPrice').textContent]);
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'CalculRevient');
  XLSX.writeFile(wb, 'calcul-revient.xlsx');
}
function sendMail(){
  let body = `Société: ${settings.companyName}\nAdresse: ${settings.address}\n\nRésumé:\n`;
  body += `Total HT: ${document.getElementById('sumHT').textContent}\n`;
  body += `TVA: ${document.getElementById('sumTVA').textContent}\n`;
  body += `Total TTC: ${document.getElementById('sumTTC').textContent}\n`;
  body += `Prix final: ${document.getElementById('finalPrice').textContent}\n\nDétails:\n`;
  document.querySelectorAll('#calcTable tbody tr').forEach(r=>{
    const desc = r.querySelector('.description')?.value || '';
    const supplier = r.querySelector('.supplier')?.value || '';
    const unit = r.querySelector('.unit')?.value || '';
    const pHT = r.querySelector('.price-ht')?.value || '';
    const pTTC = r.querySelector('.price-ttc')?.value || '';
    const qty = r.querySelector('.quantity')?.value || '';
    const total = r.querySelector('.total')?.value || '';
    body += `${desc} | ${supplier} | ${unit} | HT:${pHT} | TTC:${pTTC} | q:${qty} | total:${total}\n`;
  });
  window.location.href = `mailto:?subject=${encodeURIComponent('Calcul de revient')}&body=${encodeURIComponent(body)}`;
}
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function updateSummaryDisplay(){
  ['sumHT','sumTVA','sumTTC','globalTotalCell','globalTotalSummary','finalPrice'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const n = parseFloat(el.textContent.replace(/[^\d.-]/g,'')) || 0;
    el.textContent = n.toFixed(2) + ' ' + (settings.currency||DEFAULT_SETTINGS.currency);
  });
}
function updateHistoryControls(){
  const btn = document.getElementById('clearHistory');
  if(!btn) return;
  if(currentUser && currentUser.isAdmin){
    btn.style.display = '';
    btn.disabled = false;
  } else {
    btn.style.display = 'none';
    btn.disabled = true;
  }
}
loadSettings();
refreshUsersTable();
refreshHistoryUI();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
